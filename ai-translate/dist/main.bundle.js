(()=>{var e,t={1069:()=>{},1638:()=>{},2668:()=>{},3776:()=>{},4688:()=>{},5340:()=>{},6089:()=>{},6644:(e,t,n)=>{"use strict";n(4788);var s=n(4451);class o{constructor(){this.progressContainer=document.querySelector(".progress-container"),this.progressFill=document.querySelector(".progress-fill"),this.progressText=document.querySelector(".progress-text"),this.progressDetails=document.querySelector(".progress-details"),this.progressBatchCounter=document.createElement("div"),this.progressBatchCounter.className="progress-batch-counter",this.progressBatchCounter.style.textAlign="center",this.progressBatchCounter.style.marginTop="5px",this.progressBatchCounter.style.fontSize="14px",this.progressBatchCounter.style.color="#666",this.progressContainer.parentNode?.insertBefore(this.progressBatchCounter,this.progressContainer.nextSibling)}updateProgress(e){const t=e.current/e.total*100;this.progressFill.style.width=`${t}%`,this.progressText.textContent=`${Math.round(t)}%`,e.text&&(this.progressDetails.textContent=e.text)}updateBatchProgress(e){const t=e.completedBatches/e.totalBatches*100;if(this.progressFill.style.width=`${t}%`,this.progressText.textContent=`${Math.round(t)}%`,this.progressBatchCounter.textContent=`批次进度: ${e.completedBatches}/${e.totalBatches}`,e.currentBatchId>0){const t=e.completedTasksInCurrentBatch/e.totalTasksInCurrentBatch*100;this.progressDetails.textContent=`当前批次 ${e.currentBatchId}/${e.totalBatches}: 完成 ${Math.round(t)}%`}}reset(){this.progressFill.style.width="0%",this.progressText.textContent="0%",this.progressDetails.textContent=""}show(){this.progressContainer.style.display="block"}hide(){this.progressContainer.style.display="none"}}class r{constructor(e){this.container=e}log(e,t="info"){if(!this.container)return;const n=document.createElement("div");n.className=`log-entry ${t}`,n.textContent=`[${(new Date).toLocaleTimeString()}] ${e}`,this.container.appendChild(n),this.container.scrollTop=this.container.scrollHeight}}class a{constructor(e){this.container=e}getExcelColumnName(e){let t="";for(;e>=0;)t=String.fromCharCode(65+e%26)+t,e=Math.floor(e/26)-1;return t}updateCellInDOM(e,t,n,s){if(!this.container)return;const o=this.container.querySelector(".table-wrapper");if(!o)return;const r=o.querySelector("table");if(!r)return;if(e<s)return;const a=r.querySelectorAll("tr");let i;for(let t=0;t<a.length;t++){const n=a[t],s=n.querySelector(".row-number");if(s&&s.textContent===(e+1).toString()){i=n;break}}if(i&&t+1<i.children.length){const e=i.children[t+1];e&&(e.textContent=n)}}renderTable(e,t){if(!this.container)return;this.container.innerHTML="";const n=document.createElement("div");n.className="table-wrapper";const s=document.createElement("table");s.className="excel-table";const{headerRows:o,rows:r}=e,a=[...o,...r],i=Math.max(...o.map((e=>e.length)),...r.map((e=>e.length))),l=document.createElement("tr"),c=document.createElement("th");l.appendChild(c);for(let e=0;e<i;e++){const t=document.createElement("th");t.textContent=this.getExcelColumnName(e),t.className="column-header",l.appendChild(t)}s.appendChild(l),a.forEach(((e,n)=>{const r=document.createElement("tr");if(1!==n&&n<6)return void(r.style.display="none");const a=document.createElement("td");a.textContent=(n+1).toString(),a.className="row-number",r.appendChild(a);for(let s=0;s<i;s++){const a=document.createElement(n<o.length?"th":"td");a.textContent=e[s]||"",n>=o.length&&(a.contentEditable="true"),a.addEventListener("input",(()=>{t(n,s,a.textContent||"")})),r.appendChild(a)}s.appendChild(r)})),n.appendChild(s),this.container.appendChild(n),this.addTableStyles()}addTableStyles(){const e="fixed-table-style";if(!document.getElementById(e)){const t=document.createElement("style");t.id=e,t.textContent="\n                .table-wrapper {\n                    position: relative;\n                    overflow: auto;\n                    height: 99vh;\n                    max-width: 100%;\n                    border: 1px solid #ccc;\n                    margin: 1px;\n                    scroll-padding-top: 40px; /* 添加滚动填充，防止内容被固定头部遮挡 */\n                }\n                \n                .excel-table {\n                    border-collapse: collapse;\n                }\n                \n                .excel-table th, .excel-table td {\n                    border: 1px solid #ddd;\n                    padding: 8px;\n                    min-width: 100px;\n                }\n                \n                .excel-table th:first-child {\n                    position: sticky;\n                    left: 0;\n                    z-index: 3;\n                    background-color: #f2f2f2;\n                }\n                \n                .excel-table thead th {\n                    position: sticky;\n                    top: 0;\n                    z-index: 2;\n                    background-color: #f2f2f2;\n                    box-shadow: 0 1px 0 rgba(0,0,0,0.1); /* 添加底部阴影，增强视觉效果 */\n                }\n                \n                .excel-table tr:first-child th {\n                    position: sticky;\n                    top: 0;\n                    z-index: 2;\n                    background-color: #f2f2f2;\n                    box-shadow: 0 1px 0 rgba(0,0,0,0.1); /* 添加底部阴影，增强视觉效果 */\n                }\n                \n                /* 处理左上角单元格，同时固定在顶部和左侧 */\n                .excel-table tr:first-child th:first-child {\n                    position: sticky;\n                    top: 0;\n                    left: 0;\n                    z-index: 4; /* 最高层级，确保始终显示在最上层 */\n                    background-color: #f2f2f2;\n                    box-shadow: 1px 1px 0 rgba(0,0,0,0.1); /* 添加右侧和底部阴影 */\n                }\n                \n                .excel-table .row-number {\n                    position: sticky;\n                    left: 0;\n                    z-index: 1;\n                    background-color: #f2f2f2;\n                }\n            ",document.head.appendChild(t)}}}var i=n(3092),l=n(5483),c=n(1565);const h=new class{constructor(e="http://172.16.1.65:11434",t="nomic-embed-text",n="http://172.16.0.78:6333",s="translation_embeddings",o=768){this.ollamaUrl=e,this.modelName=t,this.collectionName=s,this.vectorSize=o,this.qdrantClient=new l.QD({url:n,checkCompatibility:!0,timeout:1e4}),console.log(`实际使用的Qdrant URL: ${n}`),console.log(`实际使用的Ollama URL: ${e}`)}async initializeCollection(){try{return(await this.qdrantClient.getCollections()).collections.some((e=>e.name===this.collectionName))?console.log(`集合已存在: ${this.collectionName}`):(await this.qdrantClient.createCollection(this.collectionName,{vectors:{size:this.vectorSize,distance:"Cosine"}}),console.log(`创建集合: ${this.collectionName}`)),!0}catch(e){return console.error("初始化向量数据库集合失败:",e),!1}}async generateEmbedding(e){try{if(!e||""===e.trim())return console.log("文本为空，无法生成向量"),null;console.log(`正在为文本生成向量: "${e.substring(0,30)}${e.length>30?"...":""}"`);const t=await i(`${this.ollamaUrl}/api/embeddings`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:this.modelName,prompt:e}),timeout:3e4});if(!t.ok){const e=await t.text();throw new Error(`Ollama API错误: ${t.status} ${t.statusText} - ${e}`)}const n=await t.json();return n&&n.embedding?(console.log(`成功生成向量，维度: ${n.embedding.length}`),n):(console.error("Ollama API返回的数据结构不正确:",JSON.stringify(n).substring(0,200)),null)}catch(e){return console.error("生成嵌入向量失败:",e),null}}async storeEmbedding(e,t){try{const n=await this.generateEmbedding(e);if(null===n)return console.error("生成嵌入向量失败，无法存储"),{success:!1,id:null};const s=c.randomUUID();return await this.qdrantClient.upsert(this.collectionName,{wait:!0,points:[{id:s,vector:n.embedding,payload:{text:e,...t}}]}),console.log(`成功存储嵌入向量: ${s}, 类型: ${t.type||"未指定"}`),{success:!0,id:s}}catch(e){return console.error("存储嵌入向量失败:",e),{success:!1,id:null}}}async storeEntryVectors(e){try{try{(await this.qdrantClient.getCollections()).collections.some((e=>e.name===this.collectionName))||(console.log(`集合不存在，正在创建: ${this.collectionName}`),await this.initializeCollection())}catch(e){console.error("检查集合时出错:",e),await this.initializeCollection()}const t=c.randomUUID(),n={chinese:e.Chinese||"",english:e.English||"",japanese:e.Japanese||"",korean:e.Korean||"",spanish:e.Spanish||"",french:e.French||"",german:e.German||"",russian:e.Russian||"",thai:e.Thai||"",italian:e.Italian||"",indonesian:e.Indonesian||"",portuguese:e.Portuguese||""};let s=null,o=null;if(e.Chinese&&""!==e.Chinese.trim())try{const t=await this.generateEmbedding(e.Chinese);t&&t.embedding&&(s=t.embedding)}catch(e){console.error("生成中文向量失败:",e)}if(e.English&&""!==e.English.trim())try{const t=await this.generateEmbedding(e.English);t&&t.embedding&&(o=t.embedding)}catch(e){console.error("生成英文向量失败:",e)}if(!s&&!o)return console.error("无法为条目生成向量嵌入:",e.Chinese),{success:!1,id:null,error:"无法生成向量嵌入"};const r={id:t,vector:s||o,payload:n};s&&o&&(r.payload.vector_cn=s,r.payload.vector_en=o);try{return await this.qdrantClient.upsert(this.collectionName,{wait:!0,points:[r]}),console.log(`成功存储翻译条目向量: ${t}`),{success:!0,id:t}}catch(e){console.error("向Qdrant存储向量失败:",e);try{return console.log("尝试重新初始化集合并重试..."),await this.initializeCollection(),await this.qdrantClient.upsert(this.collectionName,{wait:!0,points:[r]}),console.log(`重试成功，已存储翻译条目向量: ${t}`),{success:!0,id:t}}catch(e){return console.error("重试存储向量失败:",e),{success:!1,id:null,error:e.message}}}}catch(e){return console.error("存储翻译条目向量失败:",e),{success:!1,id:null,error:e.message}}}async updateEntryVectors(e,t){try{if(!e)return await this.storeEntryVectors(t);if(!t.Chinese&&!t.English)return console.error("中文和英文内容均为空，无法更新向量"),{success:!1,id:null};let n=null;t.Chinese&&(n=await this.generateEmbedding(t.Chinese),null===n&&console.error("生成中文嵌入向量失败"));let s=null;if(t.English&&(s=await this.generateEmbedding(t.English),null===s&&console.error("生成英文嵌入向量失败")),null===n&&null===s)return{success:!1,id:null};const o={id:e,vector:n||s,payload:{Chinese:t.Chinese||"",English:t.English||"",Japanese:t.Japanese||"",Korean:t.Korean||"",Spanish:t.Spanish||"",French:t.French||"",German:t.German||"",Russian:t.Russian||"",Thai:t.Thai||"",Italian:t.Italian||"",Indonesian:t.Indonesian||"",Portuguese:t.Portuguese||""}};return n&&s&&(o.payload.vector_cn=n,o.payload.vector_en=s),await this.qdrantClient.upsert(this.collectionName,{wait:!0,points:[o]}),console.log(`成功更新翻译条目向量: ${e}`),{success:!0,id:e}}catch(e){return console.error("更新翻译条目向量失败:",e),{success:!1,id:null}}}async searchSimilar(e,t="chinese",n=5){try{const s=await this.generateEmbedding(e);if(null===s)return console.error("生成嵌入向量失败，无法搜索"),[];let o;return console.log(`开始搜索相似文本，语言: ${t}, 限制: ${n}`),"english"===t?(o=await this.qdrantClient.search(this.collectionName,{vector:s.embedding,limit:n,with_payload:!0,with_vectors:!0}),o=o.map((e=>{if(e.payload&&e.payload.vector_en){const t=this.calculateCosineSimilarity(s.embedding,e.payload.vector_en);return{...e,score:t}}return e}))):(o=await this.qdrantClient.search(this.collectionName,{vector:s.embedding,limit:n,with_payload:!0,with_vectors:!0}),o=o.map((e=>{if(e.payload&&e.payload.vector_cn){const t=this.calculateCosineSimilarity(s.embedding,e.payload.vector_cn);return{...e,score:t}}return e}))),o.sort(((e,t)=>t.score-e.score)),console.log(`搜索完成，找到 ${o.length} 条结果`),o.map((e=>({id:e.id,score:e.score,metadata:{Chinese:e.payload.Chinese,English:e.payload.English,Japanese:e.payload.Japanese,Korean:e.payload.Korean,Spanish:e.payload.Spanish,French:e.payload.French,German:e.payload.German,Russian:e.payload.Russian,Thai:e.payload.Thai,Italian:e.payload.Italian,Indonesian:e.payload.Indonesian,Portuguese:e.payload.Portuguese}})))}catch(e){return console.error("搜索相似文本失败:",e),[]}}calculateCosineSimilarity(e,t){if(!e||!t||e.length!==t.length)return 0;let n=0,s=0,o=0;for(let r=0;r<e.length;r++)n+=e[r]*t[r],s+=e[r]*e[r],o+=t[r]*t[r];return s=Math.sqrt(s),o=Math.sqrt(o),0===s||0===o?0:n/(s*o)}async deleteEmbedding(e){try{return await this.qdrantClient.delete(this.collectionName,{wait:!0,points:[e]}),!0}catch(e){return console.error("删除嵌入向量失败:",e),!1}}};class g{constructor(e,t){this.apiEndpoint="https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions",this.apiKey=e||"sk-f3488cc61842433194d9ac397e52e548",this.logCallback=t||console.log,this.shouldStopTranslation=!1,this.apiKey&&console.log("已成功加载API密钥")}stopTranslation(){this.shouldStopTranslation=!0}resetStopFlag(){this.shouldStopTranslation=!1}async getTranslationMemory(e,t,n){try{if(!e||""===e.trim())return[];const s="Chinese"===t?"chinese":"english",o=await h.searchSimilar(e,s,5);if(!o||0===o.length)return console.log("未找到相似的翻译记忆"),[];const r="Chinese"===t?"Chinese":"English";let a;switch(n){case"Japanese":a="Japanese";break;case"Korean":a="Korean";break;case"Spanish":a="Spanish";break;case"French":a="French";break;case"German":a="German";break;case"Russian":a="Russian";break;case"Thai":a="Thai";break;case"Italian":a="Italian";break;case"Indonesian":a="Indonesian";break;case"Portuguese":a="Portuguese";break;case"English":a="English";break;case"Chinese":a="Chinese";break;default:a=n}const i=[];for(const e of o){const t=e.payload[r],n=e.payload[a];t&&n&&""!==t.trim()&&""!==n.trim()&&i.push({source:t,target:n})}return console.log(`找到 ${i.length} 条翻译记忆`),i}catch(e){return console.error("获取翻译记忆失败:",e),[]}}async translateBatch(e,t){try{const n=e.tasks.map((e=>e.rowIndex+3)),s=Math.min(...n),o=Math.max(...n),r=s===o?`第 ${s} 行`:`第 ${s} 行到第 ${o} 行`,a=e.tasks.length>0?e.tasks[0].targetLang:"未知";this.logCallback(`开始翻译批次 ${e.batchId} - ${t} 到 ${a} - ${r} - ${e.tasks.length}个任务`,"info"),(!this.apiKey||"string"==typeof this.apiKey&&""===this.apiKey.trim())&&(this.apiKey="sk-f3488cc61842433194d9ac397e52e548",console.log("从环境变量获取到API密钥"));const l=e.tasks.filter((e=>{try{if("string"!=typeof e.text){if(console.error("警告: 任务文本不是字符串，类型为 "+typeof e.text),null===e.text||void 0===e.text)return!1;e.text=String(e.text)}return""!==e.text.trim()}catch(t){return console.error("过滤任务时出错:",t,e),!1}}));if(0===l.length)return this.logCallback("批次中没有有效的翻译任务","warning"),!1;if(this.shouldStopTranslation)return console.log("翻译被用户停止"),this.logCallback("翻译被用户停止","warning"),!1;try{if(0===l.length)return this.logCallback("没有有效的翻译任务","warning"),!1;if(!l[0].targetLang)return console.error("错误: 目标语言未定义",l[0]),this.logCallback("错误: 目标语言未定义","error"),!1;if(console.log(`翻译批次 - 目标语言: ${l[0].targetLang}, 共${l.length}个任务`),l[0].targetLang,1===l.length){const n=l[0],s=await this.translateSingle(n,t);return e.success=s,s}const n=await i(this.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${"string"==typeof this.apiKey?this.apiKey.trim():this.apiKey}`,Accept:"application/json"},body:JSON.stringify({model:"qwen-mt-turbo",messages:[{role:"user",content:l.map((e=>e.text)).join("\n")}],translation_options:{source_lang:t,target_lang:l[0].targetLang},temperature:.7,max_tokens:2e3})});if(!n.ok){const e=await n.text();throw console.error(`翻译API错误 - 状态码: ${n.status}, 错误信息:`,e),this.logCallback(`翻译API错误: ${n.status} - ${e}`,"error"),new Error(`翻译API错误: ${n.status}`)}const s=await n.text(),o=JSON.parse(s);if(!o.choices?.[0]?.message?.content)throw console.error("翻译返回数据格式错误:",o),this.logCallback("翻译返回数据格式错误","error"),new Error("翻译返回数据格式错误");const r=o.choices[0].message.content,a="string"==typeof r?r.trim().split("\n"):[String(r)];console.log(`收到 ${a.length} 行翻译结果，共 ${l.length} 个任务`);const c=Math.min(a.length,l.length);for(let e=0;e<c;e++){const t=a[e];l[e].text="string"==typeof t?t.trim():String(t),console.log(`翻译成功 - 行号: ${l[e].rowIndex+1}, 译文: ${l[e].text}`)}if(a.length<l.length){const e=l.length-a.length;this.logCallback(`警告: ${e} 个任务没有收到翻译结果`,"warning")}return e.success=!0,!0}catch(t){return console.error(`批量翻译失败 - 批次 ${e.batchId}`,t),console.error("批次任务详情:",e.tasks.map((e=>({rowIndex:e.rowIndex,text:e.text,textType:typeof e.text})))),this.logCallback(`翻译失败: ${t.message}`,"error"),e.success=!1,!1}}catch(e){return console.error("翻译批次失败:",e),this.logCallback(`翻译失败: ${e.message}`,"error"),!1}}async translateSingle(e,t){try{console.log(`开始单个翻译 - 源语言: ${t}, 目标语言: ${e.targetLang}, 文本: ${e.text}`);const n=await this.getTranslationMemory(e.text,t,e.targetLang),s={model:"qwen-mt-turbo",messages:[{role:"user",content:e.text}],translation_options:{source_lang:t,target_lang:e.targetLang},temperature:.7,max_tokens:1e3};n&&n.length>0&&(s.translation_options.tm_list=n,console.log(`使用 ${n.length} 条翻译记忆`));const o=await i(this.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${"string"==typeof this.apiKey?this.apiKey.trim():this.apiKey}`,Accept:"application/json"},body:JSON.stringify(s)});if(!o.ok){const e=await o.text();throw console.error(`单个翻译API错误 - 状态码: ${o.status}, 错误信息:`,e),this.logCallback(`翻译API错误: ${o.status} - ${e}`,"error"),new Error(`翻译API错误: ${o.status}`)}const r=await o.json();if(!r.choices?.[0]?.message?.content)throw console.error("翻译返回数据格式错误:",r),this.logCallback("翻译返回数据格式错误","error"),new Error("翻译返回数据格式错误");const a=r.choices[0].message.content;return e.text="string"==typeof a?a.trim():String(a),console.log(`单个翻译成功 - 行号: ${e.rowIndex+1}, 译文: ${e.text}`),!0}catch(e){return console.error("单个翻译失败:",e),this.logCallback(`翻译失败: ${e.message}`,"error"),!1}}}new g;class d{constructor(e,t,n){this.apiKey=e,this.log=t,this.progressBar=n,this.shouldStopTranslation=!1}stopTranslation(){this.shouldStopTranslation=!0}createBatches(e,t){const n=[];for(let s=0;s<e.length;s+=t)n.push(e.slice(s,s+t));return n}prepareTranslationTasks(e,t,n){const s=[];for(let o=0;o<e.length;o++){const r=e[o],a=r[t];if(a&&"string"==typeof a&&""!==a.trim())for(const e of n){const n=e.index,i=e.targetLang||e.langCode,l=r[n];l&&"string"==typeof l&&""!==l.trim()||s.push({rowIndex:o,sourceColumnIndex:t,targetColumnIndex:n,targetLang:i,text:a})}}return s}organizeTasksIntoBatches(e,t=20){const n={};for(const t of e){const e=t.targetLang;n[e]||(n[e]=[]),n[e].push(t)}const s=[];let o=1;for(const e in n){const r=n[e],a=this.createBatches(r,t);for(const e of a)s.push({batchId:o++,tasks:e,success:!1,completed:0})}return s}async executeTranslation(e,t,n,s,o){try{this.log("正在收集需要翻译的内容...","info");const r=this.prepareTranslationTasks(e,t,s);if(0===r.length)return void this.log("没有找到需要翻译的内容","warning");this.log(`找到 ${r.length} 个需要翻译的单元格`,"info");const a=this.organizeTasksIntoBatches(r),i=new g(this.apiKey,this.log),l=a.length;let c=0;this.log(`开始处理 ${l} 个翻译批次`,"info");for(let t=0;t<a.length;t++){if(this.shouldStopTranslation){this.log("翻译已被用户停止","warning");break}const s=a[t],r=t+1;this.progressBar.updateBatchProgress({completedBatches:c,totalBatches:l,currentBatchId:r,completedTasksInCurrentBatch:0,totalTasksInCurrentBatch:s.tasks.length});try{const t=await i.translateBatch(s,n);if(c++,this.progressBar.updateBatchProgress({completedBatches:c,totalBatches:l,currentBatchId:0,completedTasksInCurrentBatch:s.tasks.length,totalTasksInCurrentBatch:s.tasks.length}),t){let t=0,n=0;for(const r of s.tasks)r.text&&"string"==typeof r.text&&""!==r.text.trim()?(e[r.rowIndex][r.targetColumnIndex]=r.text,o(r.rowIndex+2,r.targetColumnIndex,r.text),t++):n++;n>0&&this.log(`警告: ${n} 个单元格未获得翻译结果`,"warning")}this.log(`批次 ${r}/${l} 完成`,"success")}catch(e){this.log(`批次 ${r}/${l} 失败: ${e.message}`,"error")}}this.log(`翻译任务完成: ${c}/${l} 个批次`,c===l?"success":"warning")}catch(e){this.log(`翻译过程出错: ${e.message}`,"error"),console.error("翻译过程出错:",e)}}}class u{static getSourceLanguages(){return["Chinese","English"]}static getSourceLanguageConfig(){return{Chinese:"Chinese",English:"English"}}static getLanguageMappings(){return[{columnHeader:"英语",targetLang:"English"},{columnHeader:"日语",targetLang:"Japanese"},{columnHeader:"韩语",targetLang:"Korean"},{columnHeader:"西班牙语",targetLang:"Spanish"},{columnHeader:"法语",targetLang:"French"},{columnHeader:"德语",targetLang:"German"},{columnHeader:"俄语",targetLang:"Russian"},{columnHeader:"泰语",targetLang:"Thai"},{columnHeader:"意大利语",targetLang:"Italian"},{columnHeader:"印尼语",targetLang:"Indonesian"},{columnHeader:"葡萄牙语",targetLang:"Portuguese"}]}static getLanguageDisplayName(e){return e}static getApiLanguageCode(e){return e}static findLanguageByColumnHeader(e){if(!e)return null;const t=this.getLanguageMappings();for(const n of t)if(n.columnHeader===e)return n.targetLang;return"简体中文"===e||"中文"===e?"Chinese":null}}class p{static _eventsInitialized=!1;constructor(){console.log("ExcelTranslator 构造函数被调用"),this.tableOutput=document.getElementById("tableOutput"),this.logOutput=document.getElementById("logOutput"),this.logger=new r(this.logOutput),this.progressBar=new o,this.tableRenderer=new a(this.tableOutput),this.data={},this.currentSheet=null,this.currentFileName="",this.apiKey="",this.shouldStopTranslation=!1,this.sourceLangSelect=null,this.apiKey="sk-f3488cc61842433194d9ac397e52e548",console.log("已从环境变量加载API密钥"),this.initializeUI(),this.initializeEventListeners()}initializeUI(){this.progressBar.show(),this.progressBar.updateProgress({current:0,total:100}),this.progressBar.hide();const e=document.getElementById("stopTranslateBtn");if(e){const t=e.cloneNode(!0);e.parentNode.replaceChild(t,e),t.addEventListener("click",(()=>{this.shouldStopTranslation=!0,t.disabled=!0,this.logger.log("正在停止翻译...","warning")}))}}initializeEventListeners(){if(console.log("initializeEventListeners 被调用",(new Error).stack),p._eventsInitialized)return void console.log("事件监听器已初始化，跳过重复注册");const e=document.getElementById("fileInput"),t=document.getElementById("uploadBtn"),n=document.getElementById("translateBtn"),s=document.getElementById("exportBtn"),o=document.getElementById("actionButtons");this.sourceLangSelect=document.getElementById("sourceLang"),console.log("找到的UI元素:",{fileInput:!!e,uploadBtn:!!t,translateBtn:!!n,exportBtn:!!s}),t&&(console.log("为uploadBtn添加点击事件监听器"),t.addEventListener("click",(()=>{console.log("uploadBtn被点击"),e?.click()}))),e&&(console.log("为fileInput添加change事件监听器"),e.addEventListener("change",(e=>{console.log("fileInput change事件触发"),this.handleFileSelect(e),o&&(o.style.display="block")}))),n&&(console.log("为translateBtn添加点击事件监听器"),n.addEventListener("click",(()=>{console.log("translateBtn被点击"),this.handleTranslateClick()}))),s&&(console.log("为exportBtn添加点击事件监听器"),s.addEventListener("click",(()=>{console.log("exportBtn被点击"),this.exportToExcel()}))),p._eventsInitialized=!0,console.log("事件监听器初始化完成")}async handleFileSelect(e){const t=e.target.files[0];if(t)try{this.currentFileName=t.name,this.logger.log(`正在读取文件: ${t.name}`,"info"),this.progressBar.show(),this.data=await function(e){return new Promise(((t,n)=>{const o=new FileReader;o.onload=e=>{try{const n=e.target?.result,o=s.read(n,{type:"binary"}),r={};o.SheetNames.forEach((e=>{const t=o.Sheets[e],n=s.utils.sheet_to_json(t,{header:1}),a=n.slice(0,2),i=n.slice(2);r[e]={headerRows:a,rows:i}})),t(r)}catch(e){n(e)}},o.onerror=()=>{n(new Error("文件读取失败"))},o.readAsBinaryString(e)}))}(t),this.updateSheetSelector(Object.keys(this.data)),Object.keys(this.data).length>0&&(this.currentSheet=Object.keys(this.data)[0],this.displaySheet(),this.logger.log(`已加载工作表: ${this.currentSheet}`,"success")),this.autoDetectSourceLanguage()}catch(e){this.logger.log(`读取文件失败: ${e.message}`,"error"),console.error("文件读取错误:",e)}finally{this.progressBar.hide()}}autoDetectSourceLanguage(){if(!this.currentSheet||!this.data[this.currentSheet]||!this.sourceLangSelect)return;const{headerRows:e}=this.data[this.currentSheet];if(e.length<2)return;const t=e[1];for(let e=0;e<t.length;e++){const n=t[e];if("Chinese"===u.findLanguageByColumnHeader(n)){this.sourceLangSelect.value="Chinese",this.logger.log(`已自动检测到源语言列: ${n} (列 ${this.getExcelColumnName(e)})`,"info");break}}}updateSheetSelector(e){const t=document.getElementById("sheetSelector");t&&(t.innerHTML="",e.forEach((e=>{const n=document.createElement("option");n.value=e,n.textContent=e,t.appendChild(n)})),t.addEventListener("change",(()=>{this.currentSheet=t.value,this.displaySheet(),this.logger.log(`已切换到工作表: ${this.currentSheet}`,"info")})))}displaySheet(){if(!this.tableOutput||!this.currentSheet||!this.data[this.currentSheet])return void console.error("无法显示表格：",{tableOutput:!!this.tableOutput,currentSheet:this.currentSheet,hasData:!!this.data[this.currentSheet]});const e=this.data[this.currentSheet];this.tableRenderer.renderTable(e,((t,n,s)=>{if(t<e.headerRows.length)e.headerRows[t][n]=s;else{const o=t-e.headerRows.length;for(;e.rows.length<=o;)e.rows.push([]);for(;e.rows[o].length<=n;)e.rows[o].push("");e.rows[o][n]=s}}))}async handleTranslateClick(){if(!this.currentSheet||!this.data[this.currentSheet])return void this.logger.log("没有可翻译的数据","warning");const e=document.getElementById("translateBtn"),t=document.getElementById("stopTranslateBtn");if(e&&(e.style.display="none"),t&&(t.style.display="inline-block",t.disabled=!1),this.shouldStopTranslation=!1,this.progressBar.show(),this.progressBar.updateProgress({current:0,total:100}),this.apiKey="sk-f3488cc61842433194d9ac397e52e548",console.log("使用环境变量中的API密钥"),!this.apiKey)return this.logger.log("请输入API密钥","error"),e.style.display="inline-block",t.style.display="none",void this.progressBar.hide();const n=this.sourceLangSelect?.value||"Chinese",{headerRows:s,rows:o}=(u.getApiLanguageCode(n),this.data[this.currentSheet]);if(s.length<2)return this.logger.log("错误：表格缺少表头行","error"),e.style.display="inline-block",t.style.display="none",void this.progressBar.hide();const r=s[1];let a=-1;for(let e=0;e<r.length;e++){const t=r[e];if(u.findLanguageByColumnHeader(t)===u.getSourceLanguageConfig()[u.getLanguageDisplayName(n)]){a=e;break}}if(-1===a)return this.logger.log(`错误：找不到源语言(${u.getLanguageDisplayName(n)})列`,"error"),e.style.display="inline-block",t.style.display="none",void this.progressBar.hide();const i=[],l=u.getSourceLanguageConfig();for(let e=0;e<r.length;e++){if(e===a)continue;const t=r[e],s=u.findLanguageByColumnHeader(t);s&&s!==l[u.getLanguageDisplayName(n)]&&i.push({index:e,langCode:s,display:t})}if(0===i.length)return this.logger.log("错误：找不到任何目标语言列","error"),e.style.display="inline-block",t.style.display="none",void this.progressBar.hide();this.logger.log(`开始翻译，源语言: ${u.getLanguageDisplayName(n)} (列 ${this.getExcelColumnName(a)})`,"info"),this.logger.log("目标语言: "+i.map((e=>`${e.display} (列 ${this.getExcelColumnName(e.index)})`)).join(", "),"info");try{const e=new d(this.apiKey,this.logger.log.bind(this.logger),this.progressBar);if(t){const n=t.cloneNode(!0);t.parentNode.replaceChild(n,t),n.onclick=()=>{this.shouldStopTranslation=!0,e.stopTranslation(),n.disabled=!0,this.logger.log("正在停止翻译...","warning")}}await e.executeTranslation(o,a,n,i,((e,t,n)=>{this.tableRenderer.updateCellInDOM(e,t,n,s.length)}))}catch(e){console.error("翻译过程出错:",e),this.logger.log(`翻译过程出错: ${e.message||String(e)}`,"error")}finally{e.style.display="inline-block",t.style.display="none",t.disabled=!0,this.progressBar.hide()}}async exportToExcel(){if(this.currentSheet&&this.data[this.currentSheet])try{const e=function(e){const t=s.utils.book_new();return Object.entries(e).forEach((([e,n])=>{const o=[...n.headerRows,...n.rows],r=s.utils.aoa_to_sheet(o);s.utils.book_append_sheet(t,r,e)})),t}(this.data);s.writeFile(e,`${this.currentFileName.replace(".xlsx","")}_translated.xlsx`),this.logger.log("导出成功","success")}catch(e){e instanceof Error?this.logger.log(`导出失败: ${e.message}`,"error"):this.logger.log("导出失败: 未知错误","error")}else this.logger.log("没有可导出的数据","warning")}getExcelColumnName(e){return this.tableRenderer.getExcelColumnName(e)}}console.log("index.js 被加载"),window.addEventListener("DOMContentLoaded",(()=>{console.log("DOMContentLoaded 事件触发"),window.excelTranslatorInstance?console.log("已存在 ExcelTranslator 实例，不再创建新实例"):(console.log("创建新的 ExcelTranslator 实例"),window.excelTranslatorInstance=new p,console.log("ExcelTranslator 实例创建完成"))}))},7790:()=>{},7965:()=>{},8982:()=>{},9368:()=>{},9838:()=>{}},n={};function s(e){var o=n[e];if(void 0!==o)return o.exports;var r=n[e]={id:e,loaded:!1,exports:{}};return t[e].call(r.exports,r,r.exports,s),r.loaded=!0,r.exports}s.m=t,e=[],s.O=(t,n,o,r)=>{if(!n){var a=1/0;for(h=0;h<e.length;h++){for(var[n,o,r]=e[h],i=!0,l=0;l<n.length;l++)(!1&r||a>=r)&&Object.keys(s.O).every((e=>s.O[e](n[l])))?n.splice(l--,1):(i=!1,r<a&&(a=r));if(i){e.splice(h--,1);var c=o();void 0!==c&&(t=c)}}return t}r=r||0;for(var h=e.length;h>0&&e[h-1][2]>r;h--)e[h]=e[h-1];e[h]=[n,o,r]},s.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return s.d(t,{a:t}),t},s.d=(e,t)=>{for(var n in t)s.o(t,n)&&!s.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},s.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),s.j=792,(()=>{var e={792:0};s.O.j=t=>0===e[t];var t=(t,n)=>{var o,r,[a,i,l]=n,c=0;if(a.some((t=>0!==e[t]))){for(o in i)s.o(i,o)&&(s.m[o]=i[o]);if(l)var h=l(s)}for(t&&t(n);c<a.length;c++)r=a[c],s.o(e,r)&&e[r]&&e[r][0](),e[r]=0;return s.O(h)},n=self.webpackChunkexcel_to_structured_data=self.webpackChunkexcel_to_structured_data||[];n.forEach(t.bind(null,0)),n.push=t.bind(null,n.push.bind(n))})(),s.nc=void 0;var o=s.O(void 0,[121],(()=>s(6644)));o=s.O(o)})();
//# sourceMappingURL=main.bundle.js.map