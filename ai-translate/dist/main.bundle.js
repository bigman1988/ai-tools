(()=>{var n,e={3:()=>{},365:(n,e,t)=>{"use strict";t.d(e,{A:()=>i});var o=t(601),r=t.n(o),s=t(314),a=t.n(s)()(r());a.push([n.id,"body {\n    margin: 0;\n    padding: 0;\n    font-family: Arial, sans-serif;\n    background-color: #f5f5f5;\n}\n\n.app-container {\n    display: flex;\n    width: 100%;\n    height: 100vh;\n}\n\n.sidebar {\n    width: 17%;\n    padding: 0px;\n    background-color: #f8f9fa;\n    border-right: 1px solid #dee2e6;\n    overflow-y: auto;\n    display: flex;\n    flex-direction: column;\n}\n\n.main-content {\n    width: 83%;\n    padding: 0px;\n    overflow: hidden;\n    display: flex;\n    flex-direction: column;\n    height: 100%;\n}\n\n.file-input-container {\n    margin: 0px 10px 0px 10px;\n    display: flex;\n    flex-direction: column;\n    gap: 15px;\n    flex-shrink: 0;\n}\n\n.button-group {\n    display: flex;\n    flex-direction: column;\n    gap: 10px;\n    margin: 0px 0px;\n}\n\n.action-buttons-row {\n    display: flex;\n    gap: 10px;\n    width: 100%;\n}\n\n.action-buttons-row .btn {\n    flex: 1;\n}\n\n.source-lang-selector {\n    margin: 10px;\n    display: flex;\n    align-items: center;\n    gap: 10px;\n}\n\n.select-input {\n    flex: 1;\n    padding: 5px;\n    border: 1px solid #ddd;\n    border-radius: 4px;\n}\n\n.log-container {\n    margin-top: 5px;\n    flex: 1;\n    display: flex;\n    flex-direction: column;\n    min-height: 0;\n}\n\n.log-container h3 {\n    margin: 0 0 10px 0;\n    flex-shrink: 0;\n}\n\n.log-output {\n    flex: 1;\n    width: 99%;\n    height: 200px;\n    overflow-y: auto;\n    overflow-x: hidden;\n    background-color: #f8f9fa;\n    border: 1px solid #e9ecef;\n    border-radius: 4px;\n    padding: 0px;\n    font-family: monospace;\n    font-size: 12px;\n}\n\n.excel-table-container {\n    width: 100%;\n    height: 100%;\n    overflow: auto;\n    border: 1px solid #ddd;\n    border-radius: 4px;\n    background-color: white;\n    flex: 1;\n}\n\n.table-output {\n    width: 100%;\n    height: 100%;\n    background-color: white;\n}\n\n.excel-table {\n    width: 100%;\n    border-collapse: collapse;\n    table-layout: fixed; /* 使用固定表格布局，确保单元格宽度限制生效 */\n    min-width: 100%;\n    border-spacing: 0; /* 消除单元格间的间距 */\n}\n\n/* 第一列（行号列）的样式 */\n.excel-table td:first-child,\n.excel-table th:first-child {\n    min-width: 50px;\n    max-width: 80px;\n    text-align: center;\n    background-color: #f8f9fa;\n}\n\n.excel-table th,\n.excel-table td {\n    border: 1px solid #ddd;\n    padding: 8px;\n    text-align: left;\n    min-width: 100px;\n    max-width: 200px; /* 设置最大宽度为200px */\n    width: 200px; /* 固定宽度为200px */\n    white-space: normal;\n    word-wrap: break-word;\n    word-break: break-word; /* 允许在单词内部换行 */\n    overflow: visible; /* 改为可见，确保内容不被裁剪 */\n    height: auto !important; /* 高度自动调整，使用!important确保优先级 */\n    vertical-align: top; /* 内容顶部对齐 */\n    line-height: 1.5; /* 增加行高，使文本更易读 */\n    box-sizing: border-box; /* 确保内边距和边框不会增加元素宽度 */\n}\n\n.excel-table th {\n    background-color: #f8f9fa;\n    font-weight: bold;\n    position: sticky;\n    top: 0;\n    z-index: 10; /* 增加z-index确保表头始终在最上层 */\n    box-shadow: 0 2px 2px -1px rgba(0,0,0,0.1); /* 添加阴影增强视觉效果 */\n}\n\n.excel-table tr:nth-child(even) {\n    background-color: #f8f9fa;\n}\n\n.excel-table tr:hover {\n    background-color: #f5f5f5;\n}\n\n.upload-section {\n    border: 2px dashed #ccc;\n    padding: 20px;\n    text-align: center;\n    border-radius: 8px;\n    transition: all 0.3s ease;\n    display: flex;\n    flex-direction: column;\n    gap: 15px;\n}\n\n.upload-section.drag-over {\n    border-color: #2196F3;\n    background-color: rgba(33, 150, 243, 0.1);\n}\n\n.upload-hint {\n    color: #666;\n    margin: 0;\n    font-size: 14px;\n    transition: all 0.3s ease;\n}\n\n.upload-section.has-file .upload-hint {\n    font-size: 12px;\n    color: #999;\n}\n\n.file-name {\n    margin: 10px 0;\n    font-size: 14px;\n    color: #666;\n}\n\n/* 源语言选择器样式 */\n.source-lang-selector label {\n    color: #333;\n    font-size: 14px;\n    min-width: 70px;\n}\n\n/* 添加样式使单元格内容过多时能正确显示 */\n.excel-table tr {\n    height: auto !important; /* 行高自动调整 */\n}\n\n/* 确保长文本在单元格中正确换行 */\n.excel-table td div,\n.excel-table td span,\n.excel-table td p,\n.excel-table td {\n    max-width: 100%;\n    word-wrap: break-word;\n    word-break: break-word;\n    white-space: pre-wrap; /* 保留空白并允许换行 */\n    text-overflow: ellipsis; /* 文本过长时显示省略号 */\n}\n\n.select-input {\n    flex: 1;\n    padding: 8px 12px;\n    border: 1px solid #2196F3;\n    border-radius: 4px;\n    font-size: 14px;\n    color: #333;\n    background-color: white;\n    cursor: pointer;\n    transition: all 0.3s ease;\n}\n\n.select-input:hover {\n    border-color: #1976D2;\n}\n\n.select-input:focus {\n    outline: none;\n    border-color: #1976D2;\n    box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);\n}\n\n/* 按钮基础样式 */\n.btn {\n    padding: 8px 16px;\n    border: none;\n    border-radius: 4px;\n    cursor: pointer;\n    font-size: 14px;\n    background-color: #2196F3;\n    color: white;\n    transition: background-color 0.3s;\n}\n\n.btn:hover {\n    background-color: #1976D2;\n}\n\n.btn:active {\n    background-color: #1565C0;\n}\n\n.btn:disabled {\n    background-color: #cccccc;\n    cursor: not-allowed;\n}\n\n/* 停止按钮样式 */\n.stop-btn {\n    background-color: #dc3545;\n    color: white;\n}\n\n.stop-btn:hover {\n    background-color: #c82333;\n}\n\n/* 翻译按钮样式 */\n.translate-btn {\n    padding: 8px 16px;\n    border: none;\n    border-radius: 4px;\n    cursor: pointer;\n    font-size: 14px;\n    background-color: #4CAF50;\n    color: white;\n    transition: background-color 0.3s;\n}\n\n.translate-btn:hover {\n    background-color: #45a049;\n}\n\n.translate-btn:disabled {\n    background-color: #cccccc;\n    cursor: not-allowed;\n}\n\n/* 保存按钮样式 */\n#saveBtn, #saveJson {\n    background-color: #4CAF50;\n}\n\n#saveBtn:hover, #saveJson:hover {\n    background-color: #388E3C;\n}\n\n#saveExcel {\n    background-color: #4CAF50;\n}\n\n#saveExcel:hover {\n    background-color: #388E3C;\n}\n\n/* 进度条容器样式 */\n.progress-wrapper {\n    margin: 5px;\n    width: 95%;\n}\n\n.progress-container {\n    width: 100%;\n    height: 20px;\n    background-color: #f0f0f0;\n    border-radius: 4px;\n    overflow: hidden;\n    border: 1px solid #ddd;\n    position: relative;\n}\n\n.progress-fill {\n    height: 100%;\n    width: 0;\n    background-color: #4CAF50;\n    transition: width 0.3s ease;\n}\n\n.progress-text {\n    position: absolute;\n    left: 50%;\n    top: 50%;\n    transform: translate(-50%, -50%);\n    color: #333;\n    font-size: 12px;\n    z-index: 1;\n}\n\n.progress-details {\n    margin-top: 5px;\n    font-size: 12px;\n    color: #666;\n    text-align: center;\n}\n\n.log-container h3 {\n    margin: 0 0 10px 0;\n    color: #333;\n    font-size: 14px;\n}\n\n.log-entry {\n    margin: 5px 0;\n    padding: 5px;\n    border-radius: 3px;\n    word-wrap: break-word;\n}\n\n.log-entry .timestamp {\n    color: #666;\n    margin-right: 8px;\n}\n\n.log-entry.error {\n    color: #dc3545;\n    background-color: rgba(220, 53, 69, 0.1);\n}\n\n.log-entry.warning {\n    color: #ffc107;\n    background-color: rgba(255, 193, 7, 0.1);\n}\n\n.log-entry.success {\n    color: #28a745;\n    background-color: rgba(40, 167, 69, 0.1);\n}\n\n.excel-table th {\n    background-color: #f8f9fa;\n    font-weight: bold;\n}\n\n.excel-table tr:nth-child(even) {\n    background-color: #f8f9fa;\n}\n\n.excel-table tr:hover {\n    background-color: #f5f5f5;\n}\n\n.table-scroll-container {\n    width: 100%;\n    height: 100%;\n    overflow: auto;\n}\n\n.table-scroll-x {\n    width: 100%;\n    overflow-x: auto;\n}\n\n.table-scroll-y {\n    height: 100%;\n    overflow-y: auto;\n}\n\n.container {\n    display: flex;\n    flex-direction: column;\n    min-height: 100vh;\n    padding: 20px;\n    box-sizing: border-box;\n}\n\n.content-wrapper {\n    flex: 1;\n    display: flex;\n    flex-direction: column;\n}\n\n.timestamp {\n    color: #666;\n    font-size: 0.9em;\n    margin-right: 8px;\n}\n\n.error {\n    color: #cc0000;\n    padding: 10px;\n    margin: 10px 0;\n    background-color: #ffe8e8;\n    border: 1px solid #ffcccc;\n    border-radius: 4px;\n}\n\n.progress-container {\n    margin: 10px 0;\n    width: 100%;\n}\n\n.progress-bar {\n    width: 100%;\n    height: 20px;\n    background-color: #f0f0f0;\n    border-radius: 10px;\n    overflow: hidden;\n}\n\n.progress {\n    height: 100%;\n    background-color: #4CAF50;\n    transition: width 0.3s ease-in-out;\n}\n\n.progress-text {\n    margin-top: 5px;\n    text-align: center;\n    color: #666;\n    font-size: 14px;\n}\n",""]);const i=a},729:(n,e,t)=>{"use strict";var o=t(72),r=t.n(o),s=t(825),a=t.n(s),i=t(659),l=t.n(i),c=t(56),h=t.n(c),d=t(540),g=t.n(d),p=t(113),u=t.n(p),x=t(365),f={};f.styleTagTransform=u(),f.setAttributes=h(),f.insert=l().bind(null,"head"),f.domAPI=a(),f.insertStyleElement=g(),r()(x.A,f),x.A&&x.A.locals&&x.A.locals;var b=t(451);class m{constructor(){this.progressContainer=document.querySelector(".progress-container"),this.progressFill=document.querySelector(".progress-fill"),this.progressText=document.querySelector(".progress-text"),this.progressDetails=document.querySelector(".progress-details"),this.progressBatchCounter=document.createElement("div"),this.progressBatchCounter.className="progress-batch-counter",this.progressBatchCounter.style.textAlign="center",this.progressBatchCounter.style.marginTop="5px",this.progressBatchCounter.style.fontSize="14px",this.progressBatchCounter.style.color="#666",this.progressContainer.parentNode?.insertBefore(this.progressBatchCounter,this.progressContainer.nextSibling)}updateProgress(n){const e=n.current/n.total*100;this.progressFill.style.width=`${e}%`,this.progressText.textContent=`${Math.round(e)}%`,n.text&&(this.progressDetails.textContent=n.text)}updateBatchProgress(n){const e=n.completedBatches/n.totalBatches*100;if(this.progressFill.style.width=`${e}%`,this.progressText.textContent=`${Math.round(e)}%`,this.progressBatchCounter.textContent=`批次进度: ${n.completedBatches}/${n.totalBatches}`,n.currentBatchId>0){const e=n.completedTasksInCurrentBatch/n.totalTasksInCurrentBatch*100;this.progressDetails.textContent=`当前批次 ${n.currentBatchId}/${n.totalBatches}: 完成 ${Math.round(e)}%`}}reset(){this.progressFill.style.width="0%",this.progressText.textContent="0%",this.progressDetails.textContent=""}show(){this.progressContainer.style.display="block"}hide(){this.progressContainer.style.display="none"}}class y{constructor(n){this.container=n}log(n,e="info"){if(!this.container)return;const t=document.createElement("div");t.className=`log-entry ${e}`,t.textContent=`[${(new Date).toLocaleTimeString()}] ${n}`,this.container.appendChild(t),this.container.scrollTop=this.container.scrollHeight}}class w{constructor(n){this.container=n}getExcelColumnName(n){let e="";for(;n>=0;)e=String.fromCharCode(65+n%26)+e,n=Math.floor(n/26)-1;return e}updateCellInDOM(n,e,t,o){if(!this.container)return;const r=this.container.querySelector(".table-wrapper");if(!r)return;const s=r.querySelector("table");if(!s)return;if(n<o)return;const a=s.querySelectorAll("tr");let i;for(let e=0;e<a.length;e++){const t=a[e],o=t.querySelector(".row-number");if(o&&o.textContent===(n+1).toString()){i=t;break}}if(i&&e+1<i.children.length){const n=i.children[e+1];n&&(n.textContent=t)}}renderTable(n,e){if(!this.container)return;this.container.innerHTML="";const t=document.createElement("div");t.className="table-wrapper";const o=document.createElement("table");o.className="excel-table";const{headerRows:r,rows:s}=n,a=[...r,...s],i=Math.max(...r.map((n=>n.length)),...s.map((n=>n.length))),l=document.createElement("tr"),c=document.createElement("th");l.appendChild(c);for(let n=0;n<i;n++){const e=document.createElement("th");e.textContent=this.getExcelColumnName(n),e.className="column-header",l.appendChild(e)}o.appendChild(l),a.forEach(((n,t)=>{const s=document.createElement("tr");if(1!==t&&t<6)return void(s.style.display="none");const a=document.createElement("td");a.textContent=(t+1).toString(),a.className="row-number",s.appendChild(a);for(let o=0;o<i;o++){const a=document.createElement(t<r.length?"th":"td");a.textContent=n[o]||"",t>=r.length&&(a.contentEditable="true"),a.addEventListener("input",(()=>{e(t,o,a.textContent||"")})),s.appendChild(a)}o.appendChild(s)})),t.appendChild(o),this.container.appendChild(t),this.addTableStyles()}addTableStyles(){const n="fixed-table-style";if(!document.getElementById(n)){const e=document.createElement("style");e.id=n,e.textContent="\n                .table-wrapper {\n                    position: relative;\n                    overflow: auto;\n                    height: 99vh;\n                    max-width: 100%;\n                    border: 1px solid #ccc;\n                    margin: 1px;\n                    scroll-padding-top: 40px; /* 添加滚动填充，防止内容被固定头部遮挡 */\n                }\n                \n                .excel-table {\n                    border-collapse: collapse;\n                }\n                \n                .excel-table th, .excel-table td {\n                    border: 1px solid #ddd;\n                    padding: 8px;\n                    min-width: 100px;\n                }\n                \n                .excel-table th:first-child {\n                    position: sticky;\n                    left: 0;\n                    z-index: 3;\n                    background-color: #f2f2f2;\n                }\n                \n                .excel-table thead th {\n                    position: sticky;\n                    top: 0;\n                    z-index: 2;\n                    background-color: #f2f2f2;\n                    box-shadow: 0 1px 0 rgba(0,0,0,0.1); /* 添加底部阴影，增强视觉效果 */\n                }\n                \n                .excel-table tr:first-child th {\n                    position: sticky;\n                    top: 0;\n                    z-index: 2;\n                    background-color: #f2f2f2;\n                    box-shadow: 0 1px 0 rgba(0,0,0,0.1); /* 添加底部阴影，增强视觉效果 */\n                }\n                \n                /* 处理左上角单元格，同时固定在顶部和左侧 */\n                .excel-table tr:first-child th:first-child {\n                    position: sticky;\n                    top: 0;\n                    left: 0;\n                    z-index: 4; /* 最高层级，确保始终显示在最上层 */\n                    background-color: #f2f2f2;\n                    box-shadow: 1px 1px 0 rgba(0,0,0,0.1); /* 添加右侧和底部阴影 */\n                }\n                \n                .excel-table .row-number {\n                    position: sticky;\n                    left: 0;\n                    z-index: 1;\n                    background-color: #f2f2f2;\n                }\n            ",document.head.appendChild(e)}}}class k{constructor(n,e){this.apiEndpoint="https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions",this.apiKey=n||"sk-f3488cc61842433194d9ac397e52e548",this.logCallback=e||console.log,this.shouldStopTranslation=!1,this.apiKey&&console.log("已成功加载API密钥")}stopTranslation(){this.shouldStopTranslation=!0}resetStopFlag(){this.shouldStopTranslation=!1}async translateBatch(n,e){try{const t=n.tasks.map((n=>n.rowIndex+3)),o=Math.min(...t),r=Math.max(...t),s=o===r?`第 ${o} 行`:`第 ${o} 行到第 ${r} 行`,a=n.tasks.length>0?n.tasks[0].targetLang:"未知";this.logCallback(`开始翻译批次 ${n.batchId} - ${e} 到 ${a} - ${s} - ${n.tasks.length}个任务`,"info"),(!this.apiKey||"string"==typeof this.apiKey&&""===this.apiKey.trim())&&(this.apiKey="sk-f3488cc61842433194d9ac397e52e548",console.log("从环境变量获取到API密钥"));const i=n.tasks.filter((n=>{try{if("string"!=typeof n.text){if(console.error("警告: 任务文本不是字符串，类型为 "+typeof n.text),null===n.text||void 0===n.text)return!1;n.text=String(n.text)}return""!==n.text.trim()}catch(e){return console.error("过滤任务时出错:",e,n),!1}}));if(0===i.length)return this.logCallback("批次中没有有效的翻译任务","warning"),!1;if(this.shouldStopTranslation)return console.log("翻译被用户停止"),this.logCallback("翻译被用户停止","warning"),!1;try{if(0===i.length)return this.logCallback("没有有效的翻译任务","warning"),!1;console.log(`翻译批次 - 目标语言: ${i[0].targetLang}, 共${i.length}个任务`),i[0].targetLang;const t=await fetch(this.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${"string"==typeof this.apiKey?this.apiKey.trim():this.apiKey}`,Accept:"application/json"},body:JSON.stringify({model:"qwen-mt-turbo",messages:[{role:"user",content:i.map((n=>n.text)).join("\n")}],translation_options:{source_lang:e,target_lang:i[0].targetLang},temperature:.7,max_tokens:2e3})});if(!t.ok){const n=await t.text();throw console.error(`翻译API错误 - 状态码: ${t.status}, 错误信息:`,n),this.logCallback(`翻译API错误: ${t.status} - ${n}`,"error"),new Error(`翻译API错误: ${t.status}`)}const o=await t.text(),r=JSON.parse(o);if(!r.choices?.[0]?.message?.content)throw console.error("翻译返回数据格式错误:",r),this.logCallback("翻译返回数据格式错误","error"),new Error("翻译返回数据格式错误");const s=r.choices[0].message.content,a="string"==typeof s?s.trim().split("\n"):[String(s)];console.log(`收到 ${a.length} 行翻译结果，共 ${i.length} 个任务`);const l=Math.min(a.length,i.length);for(let n=0;n<l;n++){const e=a[n];i[n].text="string"==typeof e?e.trim():String(e),console.log(`翻译成功 - 行号: ${i[n].rowIndex+1}, 译文: ${i[n].text}`)}if(a.length<i.length){const n=i.length-a.length;this.logCallback(`警告: ${n} 个任务没有收到翻译结果`,"warning")}return n.success=!0,!0}catch(e){return console.error(`批量翻译失败 - 批次 ${n.batchId}`,e),console.error("批次任务详情:",n.tasks.map((n=>({rowIndex:n.rowIndex,text:n.text,textType:typeof n.text})))),this.logCallback(`批次 ${n.batchId} 翻译失败: ${e.message||e}`,"error"),n.success=!1,!1}n.completed=n.tasks.length}catch(e){return console.error("批次翻译失败:",e),console.error("错误堆栈:",e.stack||"无堆栈信息"),console.error("批次详细信息:",{batchId:n.batchId,taskCount:n.tasks.length,tasks:n.tasks.map((n=>({rowIndex:n.rowIndex,text:n.text?n.text:null,textType:typeof n.text})))}),this.logCallback(`批次翻译失败: ${e.message||e}`,"error"),n.success=!1,!1}}async processBatches(n,e,t,o){const r=n.length;let s=0;this.logCallback(`开始处理 ${r} 个翻译批次`,"info");for(let a=0;a<n.length;a++){if(this.shouldStopTranslation){this.logCallback("翻译已被用户停止","warning");break}const i=n[a],l=a+1;t({completedBatches:s,totalBatches:r,currentBatchId:l,completedTasksInCurrentBatch:0,totalTasksInCurrentBatch:i.tasks.length});try{const n=await this.translateBatch(i,e);s++,t({completedBatches:s,totalBatches:r,currentBatchId:0,completedTasksInCurrentBatch:i.tasks.length,totalTasksInCurrentBatch:i.tasks.length}),n&&o&&o(i),this.logCallback(`批次 ${l}/${r} 完成`,"success")}catch(n){this.logCallback(`批次 ${l}/${r} 失败`,"error")}}this.logCallback(`翻译任务完成: ${s}/${r} 个批次`,s===r?"success":"warning")}}class C{constructor(n,e,t){this.apiKey=n,this.log=e,this.progressBar=t,this.shouldStopTranslation=!1}stopTranslation(){this.shouldStopTranslation=!0}createBatches(n,e){const t=[];for(let o=0;o<n.length;o+=e)t.push(n.slice(o,o+e));return t}prepareTranslationTasks(n,e,t){const o=[];for(let r=0;r<n.length;r++){const s=n[r];for(;s.length<=Math.max(...t.map((n=>n.index)));)s.push("");const a=s[e];try{if(!a||"string"==typeof a&&""===a.trim()){this.log(`跳过第 ${r+1} 行：源文本为空`,"warning");continue}"string"!=typeof a&&(this.log(`警告: 第 ${r+1} 行的源文本不是字符串，尝试转换`,"warning"),s[e]=String(a))}catch(n){console.error(`处理行 ${r+1} 列 ${e} 的源文本时出错:`,n),this.log(`警告: 处理行 ${r+1} 列 ${e} 时出错，跳过该行`,"warning");continue}for(const n of t){try{const e=s[n.index];if(null!=e&&"string"==typeof e&&""!==e.trim())continue}catch(e){console.error(`处理行 ${r+1} 列 ${n.index} 时出错:`,e),this.log(`警告: 处理行 ${r+1} 列 ${n.index} 时出错`,"warning")}o.push({text:a,targetLang:n.langCode,rowIndex:r,columnIndex:e,targetColumnIndex:n.index,langDisplay:n.display})}}return o}organizeTasksIntoBatches(n){const e=[];let t=1;const o={};for(const e of n)o[e.targetLang]||(o[e.targetLang]=[]),o[e.targetLang].push(e);this.log(`已将翻译任务分组为 ${Object.keys(o).length} 种目标语言`,"info");for(const n in o){const r=o[n],s=r[0].langDisplay;this.log(`处理目标语言 ${s} 的 ${r.length} 个任务`,"info");let a=[],i=0;const l=2e3,c=20;for(let n=0;n<r.length;n++){const o=r[n];if((a.length>=c||i+("string"==typeof o.text?o.text.length:0)>l)&&a.length>0){const n={tasks:[...a],batchId:t++,totalCharCount:i};e.push(n),a=[],i=0}if(o.text.length>l){this.log(`警告: 任务字符数(${o.text.length})超过限制(${l})，单独处理`,"warning");const n={tasks:[o],batchId:t++,totalCharCount:o.text.length};e.push(n)}else a.push(o),i+=o.text.length}if(a.length>0){const n={tasks:a,batchId:t++,totalCharCount:i};e.push(n)}}return this.log(`将翻译任务分成了 ${e.length} 个批次`,"info"),e}async executeTranslation(n,e,t,o,r){try{this.log("正在收集需要翻译的内容...","info");const s=this.prepareTranslationTasks(n,e,o);if(0===s.length)return void this.log("没有找到需要翻译的内容","warning");this.log(`找到 ${s.length} 个需要翻译的单元格`,"info");const a=this.organizeTasksIntoBatches(s),i=new k(this.apiKey,this.log),l=t;await i.processBatches(a,l,(n=>{this.progressBar.updateBatchProgress(n)}),(e=>{let t=0;for(const o of e.tasks)o.text&&"string"==typeof o.text&&""!==o.text.trim()?(n[o.rowIndex][o.targetColumnIndex]=o.text,r(o.rowIndex+2,o.targetColumnIndex,o.text)):t++;t>0&&this.log(`警告: ${t} 个任务没有收到翻译结果`,"warning");const o=e.tasks.length>0?e.tasks[0].langDisplay:"";this.log(`已更新 ${o} 的翻译结果`,"info")})),this.log("所有翻译任务完成","success")}catch(n){const e=n.message||String(n),t=n.stack||"No stack trace available";console.error("翻译过程出错:",n),console.error("错误堆栈:",t);try{const n=t.split("\n").slice(0,3).join("\n");this.log(`翻译过程出错: ${e}\n${n}`,"error")}catch(n){this.log(`翻译过程出错: ${e}`,"error"),console.error("解析错误堆栈时出错:",n)}}}}class v{static getSourceLanguages(){return["Chinese","English"]}static getSourceLanguageConfig(){return{Chinese:"Chinese",English:"English"}}static getLanguageMappings(){return[{columnHeader:"英语",targetLang:"English"},{columnHeader:"日语",targetLang:"Japanese"},{columnHeader:"韩语",targetLang:"Korean"},{columnHeader:"西班牙语",targetLang:"Spanish"},{columnHeader:"法语",targetLang:"French"},{columnHeader:"德语",targetLang:"German"},{columnHeader:"俄语",targetLang:"Russian"},{columnHeader:"泰语",targetLang:"Thai"},{columnHeader:"意大利语",targetLang:"Italian"},{columnHeader:"印尼语",targetLang:"Indonesian"},{columnHeader:"葡萄牙语",targetLang:"Portuguese"}]}static getLanguageDisplayName(n){return n}static getApiLanguageCode(n){return n}static findLanguageByColumnHeader(n){if(!n)return null;const e=this.getLanguageMappings();for(const t of e)if(t.columnHeader===n)return t.targetLang;return"简体中文"===n||"中文"===n?"Chinese":null}}class S{constructor(){this.tableOutput=document.getElementById("tableOutput"),this.logOutput=document.getElementById("logOutput"),this.logger=new y(this.logOutput),this.progressBar=new m,this.tableRenderer=new w(this.tableOutput),this.data={},this.currentSheet=null,this.currentFileName="",this.apiKey="",this.shouldStopTranslation=!1,this.sourceLangSelect=null,this.apiKey="sk-f3488cc61842433194d9ac397e52e548",console.log("已从环境变量加载API密钥"),this.initializeUI(),this.initializeEventListeners()}initializeUI(){this.progressBar.show(),this.progressBar.updateProgress({current:0,total:100}),this.progressBar.hide();const n=document.getElementById("stopTranslateBtn");n&&n.addEventListener("click",(()=>{this.shouldStopTranslation=!0,n.disabled=!0,this.logger.log("正在停止翻译...","warning")}))}initializeEventListeners(){const n=document.getElementById("fileInput"),e=document.getElementById("uploadBtn"),t=document.getElementById("translateBtn"),o=document.getElementById("exportBtn"),r=document.getElementById("actionButtons");this.sourceLangSelect=document.getElementById("sourceLang"),e&&e.addEventListener("click",(()=>{n?.click()})),n&&n.addEventListener("change",(n=>{this.handleFileSelect(n),r&&(r.style.display="block")})),t&&t.addEventListener("click",(()=>this.handleTranslateClick())),o&&o.addEventListener("click",(()=>this.exportToExcel()))}async handleFileSelect(n){const e=n.target.files[0];if(e)try{this.currentFileName=e.name,this.logger.log(`正在读取文件: ${e.name}`,"info"),this.progressBar.show(),this.data=await function(n){return new Promise(((e,t)=>{const o=new FileReader;o.onload=n=>{try{const t=n.target?.result,o=b.read(t,{type:"binary"}),r={};o.SheetNames.forEach((n=>{const e=o.Sheets[n],t=b.utils.sheet_to_json(e,{header:1}),s=t.slice(0,2),a=t.slice(2);r[n]={headerRows:s,rows:a}})),e(r)}catch(n){t(n)}},o.onerror=()=>{t(new Error("文件读取失败"))},o.readAsBinaryString(n)}))}(e),this.updateSheetSelector(Object.keys(this.data)),Object.keys(this.data).length>0&&(this.currentSheet=Object.keys(this.data)[0],this.displaySheet(),this.logger.log(`已加载工作表: ${this.currentSheet}`,"success")),this.autoDetectSourceLanguage()}catch(n){this.logger.log(`读取文件失败: ${n.message}`,"error"),console.error("文件读取错误:",n)}finally{this.progressBar.hide()}}autoDetectSourceLanguage(){if(!this.currentSheet||!this.data[this.currentSheet]||!this.sourceLangSelect)return;const{headerRows:n}=this.data[this.currentSheet];if(n.length<2)return;const e=n[1];for(let n=0;n<e.length;n++){const t=e[n];if("Chinese"===v.findLanguageByColumnHeader(t)){this.sourceLangSelect.value="Chinese",this.logger.log(`已自动检测到源语言列: ${t} (列 ${this.getExcelColumnName(n)})`,"info");break}}}updateSheetSelector(n){const e=document.getElementById("sheetSelector");e&&(e.innerHTML="",n.forEach((n=>{const t=document.createElement("option");t.value=n,t.textContent=n,e.appendChild(t)})),e.addEventListener("change",(()=>{this.currentSheet=e.value,this.displaySheet(),this.logger.log(`已切换到工作表: ${this.currentSheet}`,"info")})))}displaySheet(){if(!this.tableOutput||!this.currentSheet||!this.data[this.currentSheet])return void console.error("无法显示表格：",{tableOutput:!!this.tableOutput,currentSheet:this.currentSheet,hasData:!!this.data[this.currentSheet]});const n=this.data[this.currentSheet];this.tableRenderer.renderTable(n,((e,t,o)=>{if(e<n.headerRows.length)n.headerRows[e][t]=o;else{const r=e-n.headerRows.length;for(;n.rows.length<=r;)n.rows.push([]);for(;n.rows[r].length<=t;)n.rows[r].push("");n.rows[r][t]=o}}))}async handleTranslateClick(){if(!this.currentSheet||!this.data[this.currentSheet])return void this.logger.log("没有可翻译的数据","warning");const n=document.getElementById("translateBtn"),e=document.getElementById("stopTranslateBtn");if(n&&(n.style.display="none"),e&&(e.style.display="inline-block",e.disabled=!1),this.shouldStopTranslation=!1,this.progressBar.show(),this.progressBar.updateProgress({current:0,total:100}),this.apiKey="sk-f3488cc61842433194d9ac397e52e548",console.log("使用环境变量中的API密钥"),!this.apiKey)return this.logger.log("请输入API密钥","error"),n.style.display="inline-block",e.style.display="none",void this.progressBar.hide();const t=this.sourceLangSelect?.value||"Chinese",{headerRows:o,rows:r}=(v.getApiLanguageCode(t),this.data[this.currentSheet]);if(o.length<2)return this.logger.log("错误：表格缺少表头行","error"),n.style.display="inline-block",e.style.display="none",void this.progressBar.hide();const s=o[1];let a=-1;for(let n=0;n<s.length;n++){const e=s[n];if(v.findLanguageByColumnHeader(e)===v.getSourceLanguageConfig()[v.getLanguageDisplayName(t)]){a=n;break}}if(-1===a)return this.logger.log(`错误：找不到源语言(${v.getLanguageDisplayName(t)})列`,"error"),n.style.display="inline-block",e.style.display="none",void this.progressBar.hide();const i=[],l=v.getSourceLanguageConfig();for(let n=0;n<s.length;n++){if(n===a)continue;const e=s[n],o=v.findLanguageByColumnHeader(e);o&&o!==l[v.getLanguageDisplayName(t)]&&i.push({index:n,langCode:o,display:e})}if(0===i.length)return this.logger.log("错误：找不到任何目标语言列","error"),n.style.display="inline-block",e.style.display="none",void this.progressBar.hide();this.logger.log(`开始翻译，源语言: ${v.getLanguageDisplayName(t)} (列 ${this.getExcelColumnName(a)})`,"info"),this.logger.log("目标语言: "+i.map((n=>`${n.display} (列 ${this.getExcelColumnName(n.index)})`)).join(", "),"info");try{const n=new C(this.apiKey,this.logger.log.bind(this.logger),this.progressBar);e&&(e.onclick=()=>{this.shouldStopTranslation=!0,n.stopTranslation(),e.disabled=!0,this.logger.log("正在停止翻译...","warning")}),await n.executeTranslation(r,a,t,i,((n,e,t)=>{this.tableRenderer.updateCellInDOM(n,e,t,o.length)}))}catch(n){console.error("翻译过程出错:",n),this.logger.log(`翻译过程出错: ${n.message||String(n)}`,"error")}finally{n.style.display="inline-block",e.style.display="none",e.disabled=!0,this.progressBar.hide()}}async exportToExcel(){if(this.currentSheet&&this.data[this.currentSheet])try{const n=function(n){const e=b.utils.book_new();return Object.entries(n).forEach((([n,t])=>{const o=[...t.headerRows,...t.rows],r=b.utils.aoa_to_sheet(o);b.utils.book_append_sheet(e,r,n)})),e}(this.data);b.writeFile(n,`${this.currentFileName.replace(".xlsx","")}_translated.xlsx`),this.logger.log("导出成功","success")}catch(n){n instanceof Error?this.logger.log(`导出失败: ${n.message}`,"error"):this.logger.log("导出失败: 未知错误","error")}else this.logger.log("没有可导出的数据","warning")}getExcelColumnName(n){return this.tableRenderer.getExcelColumnName(n)}}window.addEventListener("DOMContentLoaded",(()=>{window.excelTranslatorInstance=new S}))}},t={};function o(n){var r=t[n];if(void 0!==r)return r.exports;var s=t[n]={id:n,exports:{}};return e[n].call(s.exports,s,s.exports,o),s.exports}o.m=e,n=[],o.O=(e,t,r,s)=>{if(!t){var a=1/0;for(h=0;h<n.length;h++){for(var[t,r,s]=n[h],i=!0,l=0;l<t.length;l++)(!1&s||a>=s)&&Object.keys(o.O).every((n=>o.O[n](t[l])))?t.splice(l--,1):(i=!1,s<a&&(a=s));if(i){n.splice(h--,1);var c=r();void 0!==c&&(e=c)}}return e}s=s||0;for(var h=n.length;h>0&&n[h-1][2]>s;h--)n[h]=n[h-1];n[h]=[t,r,s]},o.n=n=>{var e=n&&n.__esModule?()=>n.default:()=>n;return o.d(e,{a:e}),e},o.d=(n,e)=>{for(var t in e)o.o(e,t)&&!o.o(n,t)&&Object.defineProperty(n,t,{enumerable:!0,get:e[t]})},o.o=(n,e)=>Object.prototype.hasOwnProperty.call(n,e),(()=>{var n={792:0};o.O.j=e=>0===n[e];var e=(e,t)=>{var r,s,[a,i,l]=t,c=0;if(a.some((e=>0!==n[e]))){for(r in i)o.o(i,r)&&(o.m[r]=i[r]);if(l)var h=l(o)}for(e&&e(t);c<a.length;c++)s=a[c],o.o(n,s)&&n[s]&&n[s][0](),n[s]=0;return o.O(h)},t=self.webpackChunkexcel_to_structured_data=self.webpackChunkexcel_to_structured_data||[];t.forEach(e.bind(null,0)),t.push=e.bind(null,t.push.bind(t))})(),o.nc=void 0;var r=o.O(void 0,[121],(()=>o(729)));r=o.O(r)})();