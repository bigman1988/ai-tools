(()=>{var t,n={3:()=>{},365:(t,n,e)=>{"use strict";e.d(n,{A:()=>l});var o=e(601),r=e.n(o),s=e(314),a=e.n(s)()(r());a.push([t.id,"body {\n    margin: 0;\n    padding: 0;\n    font-family: Arial, sans-serif;\n    background-color: #f5f5f5;\n}\n\n.app-container {\n    display: flex;\n    width: 100%;\n    height: 100vh;\n}\n\n.sidebar {\n    width: 17%;\n    padding: 0px;\n    background-color: #f8f9fa;\n    border-right: 1px solid #dee2e6;\n    overflow-y: auto;\n    display: flex;\n    flex-direction: column;\n}\n\n.main-content {\n    width: 83%;\n    padding: 0px;\n    overflow: hidden;\n    display: flex;\n    flex-direction: column;\n    height: 100%;\n}\n\n.file-input-container {\n    margin: 0px 10px 0px 10px;\n    display: flex;\n    flex-direction: column;\n    gap: 15px;\n    flex-shrink: 0;\n}\n\n.button-group {\n    display: flex;\n    flex-direction: column;\n    gap: 10px;\n    margin: 0px 0px;\n}\n\n.action-buttons-row {\n    display: flex;\n    gap: 10px;\n    width: 100%;\n}\n\n.action-buttons-row .btn {\n    flex: 1;\n}\n\n.source-lang-selector {\n    margin: 10px;\n    display: flex;\n    align-items: center;\n    gap: 10px;\n}\n\n.select-input {\n    flex: 1;\n    padding: 5px;\n    border: 1px solid #ddd;\n    border-radius: 4px;\n}\n\n.log-container {\n    margin-top: 5px;\n    flex: 1;\n    display: flex;\n    flex-direction: column;\n    min-height: 0;\n}\n\n.log-container h3 {\n    margin: 0 0 10px 0;\n    flex-shrink: 0;\n}\n\n.log-output {\n    flex: 1;\n    width: 99%;\n    height: 200px;\n    overflow-y: auto;\n    overflow-x: hidden;\n    background-color: #f8f9fa;\n    border: 1px solid #e9ecef;\n    border-radius: 4px;\n    padding: 0px;\n    font-family: monospace;\n    font-size: 12px;\n}\n\n.excel-table-container {\n    width: 100%;\n    height: 100%;\n    overflow: auto;\n    border: 1px solid #ddd;\n    border-radius: 4px;\n    background-color: white;\n    flex: 1;\n}\n\n.table-output {\n    width: 100%;\n    height: 100%;\n    background-color: white;\n}\n\n.excel-table {\n    width: 100%;\n    border-collapse: collapse;\n    table-layout: fixed; /* 使用固定表格布局，确保单元格宽度限制生效 */\n    min-width: 100%;\n    border-spacing: 0; /* 消除单元格间的间距 */\n}\n\n/* 第一列（行号列）的样式 */\n.excel-table td:first-child,\n.excel-table th:first-child {\n    min-width: 50px;\n    max-width: 80px;\n    text-align: center;\n    background-color: #f8f9fa;\n}\n\n.excel-table th,\n.excel-table td {\n    border: 1px solid #ddd;\n    padding: 8px;\n    text-align: left;\n    min-width: 100px;\n    max-width: 200px; /* 设置最大宽度为200px */\n    width: 200px; /* 固定宽度为200px */\n    white-space: normal;\n    word-wrap: break-word;\n    word-break: break-word; /* 允许在单词内部换行 */\n    overflow: visible; /* 改为可见，确保内容不被裁剪 */\n    height: auto !important; /* 高度自动调整，使用!important确保优先级 */\n    vertical-align: top; /* 内容顶部对齐 */\n    line-height: 1.5; /* 增加行高，使文本更易读 */\n    box-sizing: border-box; /* 确保内边距和边框不会增加元素宽度 */\n}\n\n.excel-table th {\n    background-color: #f8f9fa;\n    font-weight: bold;\n    position: sticky;\n    top: 0;\n    z-index: 10; /* 增加z-index确保表头始终在最上层 */\n    box-shadow: 0 2px 2px -1px rgba(0,0,0,0.1); /* 添加阴影增强视觉效果 */\n}\n\n.excel-table tr:nth-child(even) {\n    background-color: #f8f9fa;\n}\n\n.excel-table tr:hover {\n    background-color: #f5f5f5;\n}\n\n.upload-section {\n    border: 2px dashed #ccc;\n    padding: 20px;\n    text-align: center;\n    border-radius: 8px;\n    transition: all 0.3s ease;\n    display: flex;\n    flex-direction: column;\n    gap: 15px;\n}\n\n.upload-section.drag-over {\n    border-color: #2196F3;\n    background-color: rgba(33, 150, 243, 0.1);\n}\n\n.upload-hint {\n    color: #666;\n    margin: 0;\n    font-size: 14px;\n    transition: all 0.3s ease;\n}\n\n.upload-section.has-file .upload-hint {\n    font-size: 12px;\n    color: #999;\n}\n\n.file-name {\n    margin: 10px 0;\n    font-size: 14px;\n    color: #666;\n}\n\n/* 源语言选择器样式 */\n.source-lang-selector label {\n    color: #333;\n    font-size: 14px;\n    min-width: 70px;\n}\n\n/* 添加样式使单元格内容过多时能正确显示 */\n.excel-table tr {\n    height: auto !important; /* 行高自动调整 */\n}\n\n/* 确保长文本在单元格中正确换行 */\n.excel-table td div,\n.excel-table td span,\n.excel-table td p,\n.excel-table td {\n    max-width: 100%;\n    word-wrap: break-word;\n    word-break: break-word;\n    white-space: pre-wrap; /* 保留空白并允许换行 */\n    text-overflow: ellipsis; /* 文本过长时显示省略号 */\n}\n\n.select-input {\n    flex: 1;\n    padding: 8px 12px;\n    border: 1px solid #2196F3;\n    border-radius: 4px;\n    font-size: 14px;\n    color: #333;\n    background-color: white;\n    cursor: pointer;\n    transition: all 0.3s ease;\n}\n\n.select-input:hover {\n    border-color: #1976D2;\n}\n\n.select-input:focus {\n    outline: none;\n    border-color: #1976D2;\n    box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);\n}\n\n/* 按钮基础样式 */\n.btn {\n    padding: 8px 16px;\n    border: none;\n    border-radius: 4px;\n    cursor: pointer;\n    font-size: 14px;\n    background-color: #2196F3;\n    color: white;\n    transition: background-color 0.3s;\n}\n\n.btn:hover {\n    background-color: #1976D2;\n}\n\n.btn:active {\n    background-color: #1565C0;\n}\n\n.btn:disabled {\n    background-color: #cccccc;\n    cursor: not-allowed;\n}\n\n/* 停止按钮样式 */\n.stop-btn {\n    background-color: #dc3545;\n    color: white;\n}\n\n.stop-btn:hover {\n    background-color: #c82333;\n}\n\n/* 翻译按钮样式 */\n.translate-btn {\n    padding: 8px 16px;\n    border: none;\n    border-radius: 4px;\n    cursor: pointer;\n    font-size: 14px;\n    background-color: #4CAF50;\n    color: white;\n    transition: background-color 0.3s;\n}\n\n.translate-btn:hover {\n    background-color: #45a049;\n}\n\n.translate-btn:disabled {\n    background-color: #cccccc;\n    cursor: not-allowed;\n}\n\n/* 保存按钮样式 */\n#saveBtn, #saveJson {\n    background-color: #4CAF50;\n}\n\n#saveBtn:hover, #saveJson:hover {\n    background-color: #388E3C;\n}\n\n#saveExcel {\n    background-color: #4CAF50;\n}\n\n#saveExcel:hover {\n    background-color: #388E3C;\n}\n\n/* 进度条容器样式 */\n.progress-wrapper {\n    margin: 5px;\n    width: 95%;\n}\n\n.progress-container {\n    width: 100%;\n    height: 20px;\n    background-color: #f0f0f0;\n    border-radius: 4px;\n    overflow: hidden;\n    border: 1px solid #ddd;\n    position: relative;\n}\n\n.progress-fill {\n    height: 100%;\n    width: 0;\n    background-color: #4CAF50;\n    transition: width 0.3s ease;\n}\n\n.progress-text {\n    position: absolute;\n    left: 50%;\n    top: 50%;\n    transform: translate(-50%, -50%);\n    color: #333;\n    font-size: 12px;\n    z-index: 1;\n}\n\n.progress-details {\n    margin-top: 5px;\n    font-size: 12px;\n    color: #666;\n    text-align: center;\n}\n\n.log-container h3 {\n    margin: 0 0 10px 0;\n    color: #333;\n    font-size: 14px;\n}\n\n.log-entry {\n    margin: 5px 0;\n    padding: 5px;\n    border-radius: 3px;\n    word-wrap: break-word;\n}\n\n.log-entry .timestamp {\n    color: #666;\n    margin-right: 8px;\n}\n\n.log-entry.error {\n    color: #dc3545;\n    background-color: rgba(220, 53, 69, 0.1);\n}\n\n.log-entry.warning {\n    color: #ffc107;\n    background-color: rgba(255, 193, 7, 0.1);\n}\n\n.log-entry.success {\n    color: #28a745;\n    background-color: rgba(40, 167, 69, 0.1);\n}\n\n.excel-table th {\n    background-color: #f8f9fa;\n    font-weight: bold;\n}\n\n.excel-table tr:nth-child(even) {\n    background-color: #f8f9fa;\n}\n\n.excel-table tr:hover {\n    background-color: #f5f5f5;\n}\n\n.table-scroll-container {\n    width: 100%;\n    height: 100%;\n    overflow: auto;\n}\n\n.table-scroll-x {\n    width: 100%;\n    overflow-x: auto;\n}\n\n.table-scroll-y {\n    height: 100%;\n    overflow-y: auto;\n}\n\n.container {\n    display: flex;\n    flex-direction: column;\n    min-height: 100vh;\n    padding: 20px;\n    box-sizing: border-box;\n}\n\n.content-wrapper {\n    flex: 1;\n    display: flex;\n    flex-direction: column;\n}\n\n.timestamp {\n    color: #666;\n    font-size: 0.9em;\n    margin-right: 8px;\n}\n\n.error {\n    color: #cc0000;\n    padding: 10px;\n    margin: 10px 0;\n    background-color: #ffe8e8;\n    border: 1px solid #ffcccc;\n    border-radius: 4px;\n}\n\n.progress-container {\n    margin: 10px 0;\n    width: 100%;\n}\n\n.progress-bar {\n    width: 100%;\n    height: 20px;\n    background-color: #f0f0f0;\n    border-radius: 10px;\n    overflow: hidden;\n}\n\n.progress {\n    height: 100%;\n    background-color: #4CAF50;\n    transition: width 0.3s ease-in-out;\n}\n\n.progress-text {\n    margin-top: 5px;\n    text-align: center;\n    color: #666;\n    font-size: 14px;\n}\n",""]);const l=a},845:(t,n,e)=>{"use strict";var o=e(72),r=e.n(o),s=e(825),a=e.n(s),l=e(659),i=e.n(l),c=e(56),h=e.n(c),d=e(540),g=e.n(d),p=e(113),u=e.n(p),x=e(365),f={};f.styleTagTransform=u(),f.setAttributes=h(),f.insert=i().bind(null,"head"),f.domAPI=a(),f.insertStyleElement=g(),r()(x.A,f),x.A&&x.A.locals&&x.A.locals;var b=e(451);class m{constructor(t,n){this.apiEndpoint="https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions",this.apiKey=t||"sk-f3488cc61842433194d9ac397e52e548",this.logCallback=n||console.log,this.shouldStopTranslation=!1,this.apiKey&&console.log("已成功加载API密钥")}stopTranslation(){this.shouldStopTranslation=!0}resetStopFlag(){this.shouldStopTranslation=!1}async translateBatch(t,n){try{const e=t.tasks.map((t=>t.rowIndex+3)),o=Math.min(...e),r=Math.max(...e),s=o===r?`第 ${o} 行`:`第 ${o} 行到第 ${r} 行`,a=t.tasks.length>0?t.tasks[0].targetLang:"未知";this.logCallback(`开始翻译批次 ${t.batchId} - ${n} 到 ${a} - ${s} - ${t.tasks.length}个任务`,"info"),(!this.apiKey||"string"==typeof this.apiKey&&""===this.apiKey.trim())&&(this.apiKey="sk-f3488cc61842433194d9ac397e52e548",console.log("从环境变量获取到API密钥"));const l=t.tasks.filter((t=>{try{if("string"!=typeof t.text){if(console.error("警告: 任务文本不是字符串，类型为 "+typeof t.text),null===t.text||void 0===t.text)return!1;t.text=String(t.text)}return""!==t.text.trim()}catch(n){return console.error("过滤任务时出错:",n,t),!1}}));if(0===l.length)return this.logCallback("批次中没有有效的翻译任务","warning"),!1;if(this.shouldStopTranslation)return console.log("翻译被用户停止"),this.logCallback("翻译被用户停止","warning"),!1;try{if(0===l.length)return this.logCallback("没有有效的翻译任务","warning"),!1;console.log(`翻译批次 - 目标语言: ${l[0].targetLang}, 共${l.length}个任务`),l[0].targetLang;const e=await fetch(this.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${"string"==typeof this.apiKey?this.apiKey.trim():this.apiKey}`,Accept:"application/json"},body:JSON.stringify({model:"qwen-mt-turbo",messages:[{role:"user",content:l.map((t=>t.text)).join("\n")}],translation_options:{source_lang:n,target_lang:l[0].targetLang},temperature:.7,max_tokens:2e3})});if(!e.ok){const t=await e.text();throw console.error(`翻译API错误 - 状态码: ${e.status}, 错误信息:`,t),this.logCallback(`翻译API错误: ${e.status} - ${t}`,"error"),new Error(`翻译API错误: ${e.status}`)}const o=await e.text(),r=JSON.parse(o);if(!r.choices?.[0]?.message?.content)throw console.error("翻译返回数据格式错误:",r),this.logCallback("翻译返回数据格式错误","error"),new Error("翻译返回数据格式错误");const s=r.choices[0].message.content,a="string"==typeof s?s.trim().split("\n"):[String(s)];console.log(`收到 ${a.length} 行翻译结果，共 ${l.length} 个任务`);const i=Math.min(a.length,l.length);for(let t=0;t<i;t++){const n=a[t];l[t].text="string"==typeof n?n.trim():String(n),console.log(`翻译成功 - 行号: ${l[t].rowIndex+1}, 译文: ${l[t].text}`)}if(a.length<l.length){const t=l.length-a.length;this.logCallback(`警告: ${t} 个任务没有收到翻译结果`,"warning")}return t.success=!0,!0}catch(n){return console.error(`批量翻译失败 - 批次 ${t.batchId}`,n),console.error("批次任务详情:",t.tasks.map((t=>({rowIndex:t.rowIndex,text:t.text,textType:typeof t.text})))),this.logCallback(`批次 ${t.batchId} 翻译失败: ${n.message||n}`,"error"),t.success=!1,!1}t.completed=t.tasks.length}catch(n){return console.error("批次翻译失败:",n),console.error("错误堆栈:",n.stack||"无堆栈信息"),console.error("批次详细信息:",{batchId:t.batchId,taskCount:t.tasks.length,tasks:t.tasks.map((t=>({rowIndex:t.rowIndex,text:t.text?t.text:null,textType:typeof t.text})))}),this.logCallback(`批次翻译失败: ${n.message||n}`,"error"),t.success=!1,!1}}async processBatches(t,n,e,o){const r=t.length;let s=0;this.logCallback(`开始处理 ${r} 个翻译批次`,"info");for(let a=0;a<t.length;a++){if(this.shouldStopTranslation){this.logCallback("翻译已被用户停止","warning");break}const l=t[a],i=a+1;e({completedBatches:s,totalBatches:r,currentBatchId:i,completedTasksInCurrentBatch:0,totalTasksInCurrentBatch:l.tasks.length});try{const t=await this.translateBatch(l,n);s++,e({completedBatches:s,totalBatches:r,currentBatchId:0,completedTasksInCurrentBatch:l.tasks.length,totalTasksInCurrentBatch:l.tasks.length}),t&&o&&o(l),this.logCallback(`批次 ${i}/${r} 完成`,"success")}catch(t){this.logCallback(`批次 ${i}/${r} 失败`,"error")}}this.logCallback(`翻译任务完成: ${s}/${r} 个批次`,s===r?"success":"warning")}}class y{constructor(){this.progressContainer=document.querySelector(".progress-container"),this.progressFill=document.querySelector(".progress-fill"),this.progressText=document.querySelector(".progress-text"),this.progressDetails=document.querySelector(".progress-details"),this.progressBatchCounter=document.createElement("div"),this.progressBatchCounter.className="progress-batch-counter",this.progressBatchCounter.style.textAlign="center",this.progressBatchCounter.style.marginTop="5px",this.progressBatchCounter.style.fontSize="14px",this.progressBatchCounter.style.color="#666",this.progressContainer.parentNode?.insertBefore(this.progressBatchCounter,this.progressContainer.nextSibling)}updateProgress(t){const n=t.current/t.total*100;this.progressFill.style.width=`${n}%`,this.progressText.textContent=`${Math.round(n)}%`,t.text&&(this.progressDetails.textContent=t.text)}updateBatchProgress(t){const n=t.completedBatches/t.totalBatches*100;if(this.progressFill.style.width=`${n}%`,this.progressText.textContent=`${Math.round(n)}%`,this.progressBatchCounter.textContent=`批次进度: ${t.completedBatches}/${t.totalBatches}`,t.currentBatchId>0){const n=t.completedTasksInCurrentBatch/t.totalTasksInCurrentBatch*100;this.progressDetails.textContent=`当前批次 ${t.currentBatchId}/${t.totalBatches}: 完成 ${Math.round(n)}%`}}reset(){this.progressFill.style.width="0%",this.progressText.textContent="0%",this.progressDetails.textContent=""}show(){this.progressContainer.style.display="block"}hide(){this.progressContainer.style.display="none"}}window.excelTranslatorInstance=new class{constructor(){this.tableOutput=document.getElementById("tableOutput"),this.data={},this.currentSheet="",this.sourceLangSelect=null,this.apiKey="",this.currentFileName="",this.originalWorkbook=null,this.shouldStopTranslation=!1,this.progressBar=new y,this.sourceColumnIndex=-1,this.targetLanguages=[],this.targetColumnIndices=[],this.sourceLanguages=["简体中文","英语"],this.languageMappings=[{columnHeader:"英语",targetLang:"English"},{columnHeader:"日语",targetLang:"Japanese"},{columnHeader:"韩语",targetLang:"Korean"},{columnHeader:"西班牙语",targetLang:"Spanish"},{columnHeader:"法语",targetLang:"French"},{columnHeader:"德语",targetLang:"German"},{columnHeader:"俄语",targetLang:"Russian"},{columnHeader:"泰语",targetLang:"Thai"},{columnHeader:"意大利语",targetLang:"Italian"},{columnHeader:"印尼语",targetLang:"Indonesian"},{columnHeader:"葡萄牙语",targetLang:"Portuguese"}],this.sourceLanguageConfig={简体中文:"Chinese",英语:"English"},this.batchSize=10,this.currentBatchNumber=0,window.excelTranslatorInstance?console.log("检测到已存在实例，跳过事件监听器初始化"):(this.initializeEventListeners(),this.initializeUI(),console.log("初始化事件监听器和UI")),this.apiKey="sk-f3488cc61842433194d9ac397e52e548",console.log("已从环境变量加载API密钥");const t=document.getElementById("apiKeyInput");if(t){if(this.apiKey){const n=this.apiKey.substring(0,4)+"..."+this.apiKey.substring(this.apiKey.length-4);t.value=n,t.setAttribute("placeholder","使用环境变量中的API密钥")}t.addEventListener("change",(n=>{const e=n.target.value;e&&e!==t.getAttribute("placeholder")&&(this.apiKey=e,console.log("已使用手动输入的API密钥"))}))}}async translateCell(t,n){const e=document.getElementById("sourceLang"),o=e?.value||"zh-CN",r=this.sourceLanguageConfig["en"===o?"英语":"简体中文"];console.log(`翻译请求 - 源语言: ${r}, 目标语言: ${n}, 文本: ${t}`);try{const e=await fetch("https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey.trim()}`,Accept:"application/json"},body:JSON.stringify({model:"qwen-mt-turbo",messages:[{role:"user",content:t}],translation_options:{source_lang:r,target_lang:n},temperature:.7,max_tokens:2e3})});if(!e.ok){const t=await e.text();throw console.error(`翻译API错误 - 状态码: ${e.status}, 错误信息:`,t),this.log(`翻译API错误: ${e.status} - ${t}`,"error"),new Error(`翻译API错误: ${e.status}`)}return(await e.json()).choices[0].message.content.trim()}catch(t){throw console.error("翻译出错:",t),this.log(`翻译出错: ${t.message}`,"error"),t}}async handleFileSelect(t){const n=t.target;if(n.files&&n.files[0])try{this.log("正在读取Excel文件...","info");const t=n.files[0],e=await function(t){return new Promise(((n,e)=>{const o=new FileReader;o.onload=t=>{try{const e=t.target?.result,o=b.read(e,{type:"binary"}),r={};o.SheetNames.forEach((t=>{const n=o.Sheets[t],e=b.utils.sheet_to_json(n,{header:1}),s=e.slice(0,2),a=e.slice(2);r[t]={headerRows:s,rows:a}})),n(r)}catch(t){e(t)}},o.onerror=()=>{e(new Error("文件读取失败"))},o.readAsBinaryString(t)}))}(t);this.data=e,this.currentFileName=t.name;const o=document.getElementById("fileName");if(o&&(o.textContent=t.name),this.log(`成功读取Excel文件: ${t.name}`,"success"),this.log(`工作表数量: ${Object.keys(e).length}`,"info"),this.tableOutput=document.getElementById("tableOutput"),!this.tableOutput)return console.error("表格容器元素不存在"),void this.log("无法找到表格容器元素","error");this.updateSheetSelector(Object.keys(e)),Object.keys(e).length>0&&(this.currentSheet=Object.keys(e)[0],this.log(`显示工作表: ${this.currentSheet}`,"info"),this.displaySheet())}catch(t){console.error("Error reading Excel file:",t),this.log("读取Excel文件失败","error")}}async handleTranslateClick(){const t=document.getElementById("translateBtn"),n=document.getElementById("stopTranslateBtn");if(t.style.display="none",n.style.display="inline-block",this.progressBar.show(),n.disabled=!1,this.shouldStopTranslation=!1,this.currentBatchNumber=0,!this.apiKey||""===this.apiKey.trim())return this.log("错误：API密钥未设置","error"),t.style.display="inline-block",n.style.display="none",void this.progressBar.hide();const e=document.getElementById("sourceLang");let o="简体中文",r="Chinese";"en"===(e?.value||"zh-CN")&&(o="英语",r="English");const{headerRows:s}=this.data[this.currentSheet];if(0===s.length)return this.log("错误：找不到表头行","error"),t.style.display="inline-block",n.style.display="none",void this.progressBar.hide();const a=s[1];let l=-1;for(let t=0;t<a.length;t++)if(a[t]===o){l=t;break}if(-1===l)return this.log(`错误：在表头中找不到源语言 "${o}" 列`,"error"),t.style.display="inline-block",n.style.display="none",void this.progressBar.hide();const i=[];for(let t=0;t<a.length;t++){if(t===l)continue;const n=this.languageMappings.find((n=>n.columnHeader===a[t]));if(n){if("英语"===o&&"简体中文"===a[t])continue;i.push({index:t,langCode:n.targetLang,display:n.columnHeader})}}if(0===i.length)return this.log("错误：找不到任何目标语言列","error"),t.style.display="inline-block",n.style.display="none",void this.progressBar.hide();this.log(`开始翻译，源语言: ${o} (列 ${this.getExcelColumnName(l)})`,"info"),this.log("目标语言: "+i.map((t=>`${t.display} (列 ${this.getExcelColumnName(t.index)})`)).join(", "),"info");const c=this.data[this.currentSheet].rows;try{const e=[];this.log("正在收集需要翻译的内容...","info");for(let t=0;t<c.length;t++){const n=c[t];for(;n.length<=Math.max(...i.map((t=>t.index)));)n.push("");const o=n[l];try{if(!o||"string"==typeof o&&""===o.trim()){this.log(`跳过第 ${t+1} 行：源文本为空`,"warning");continue}"string"!=typeof o&&(this.log(`警告: 第 ${t+1} 行的源文本不是字符串，尝试转换`,"warning"),n[l]=String(o))}catch(n){console.error(`处理行 ${t+1} 列 ${l} 的源文本时出错:`,n),this.log(`警告: 处理行 ${t+1} 列 ${l} 时出错，跳过该行`,"warning");continue}for(const r of i){try{const t=n[r.index];if(null!=t&&"string"==typeof t&&""!==t.trim())continue}catch(n){console.error(`处理行 ${t+1} 列 ${r.index} 时出错:`,n),this.log(`警告: 处理行 ${t+1} 列 ${r.index} 时出错`,"warning")}e.push({text:o,targetLang:r.langCode,rowIndex:t,columnIndex:l,targetColumnIndex:r.index,langDisplay:r.display})}}if(0===e.length)return this.log("没有找到需要翻译的内容","warning"),t.style.display="inline-block",n.style.display="none",void this.progressBar.hide();this.log(`找到 ${e.length} 个需要翻译的单元格`,"info");const o=[];let s=1;const a={};for(const t of e)a[t.targetLang]||(a[t.targetLang]=[]),a[t.targetLang].push(t);this.log(`已将翻译任务分组为 ${Object.keys(a).length} 种目标语言`,"info");for(const t in a){const n=a[t],e=n[0].langDisplay;this.log(`处理目标语言 ${e} 的 ${n.length} 个任务`,"info");let r=[],l=0;const i=2e3,c=20;for(let t=0;t<n.length;t++){const e=n[t];if((r.length>=c||l+("string"==typeof e.text?e.text.length:0)>i)&&r.length>0){const t={tasks:[...r],batchId:s++,totalCharCount:l};o.push(t),r=[],l=0}if(e.text.length>i){this.log(`警告: 任务字符数(${e.text.length})超过限制(${i})，单独处理`,"warning");const t={tasks:[e],batchId:s++,totalCharCount:e.text.length};o.push(t)}else r.push(e),l+=e.text.length}if(r.length>0){const t={tasks:r,batchId:s++,totalCharCount:l};o.push(t)}}this.log(`将翻译任务分成了 ${o.length} 个批次`,"info");const h=new m(this.apiKey,this.log.bind(this));n.onclick=()=>{this.shouldStopTranslation=!0,h.stopTranslation(),n.disabled=!0,this.log("正在停止翻译...","warning")},await h.processBatches(o,r,(t=>{this.progressBar.updateBatchProgress(t)}),(t=>{let n=0;for(const e of t.tasks)e.text&&"string"==typeof e.text&&""!==e.text.trim()?(c[e.rowIndex][e.targetColumnIndex]=e.text,this.updateCellInDOM(e.rowIndex+2,e.targetColumnIndex,e.text)):n++;n>0&&this.log(`警告: ${n} 个任务没有收到翻译结果`,"warning");const e=t.tasks.length>0?t.tasks[0].langDisplay:"";this.log(`已更新 ${e} 的翻译结果`,"info")})),this.log("所有翻译任务完成","success")}catch(t){const n=t.message||String(t),e=t.stack||"No stack trace available";console.error("翻译过程出错:",t),console.error("错误堆栈:",e);try{const t=e.split("\n").slice(0,3).join("\n");this.log(`翻译过程出错: ${n}\n${t}`,"error")}catch(t){this.log(`翻译过程出错: ${n}`,"error"),console.error("解析错误堆栈时出错:",t)}}finally{t.style.display="inline-block",n.style.display="none",n.disabled=!0,this.progressBar.hide()}}createBatches(t,n){const e=[];for(let o=0;o<t.length;o+=n)e.push(t.slice(o,o+n));return e}initializeUI(){this.progressBar.show(),this.progressBar.updateProgress({current:0,total:100}),this.progressBar.hide();const t=document.getElementById("stopTranslateBtn");t&&t.addEventListener("click",(()=>{this.shouldStopTranslation=!0,t.disabled=!0,this.log("正在停止翻译...","warning")}))}initializeEventListeners(){const t=document.getElementById("fileInput"),n=document.getElementById("uploadBtn"),e=document.getElementById("translateBtn"),o=document.getElementById("exportBtn"),r=document.getElementById("actionButtons");this.sourceLangSelect=document.getElementById("sourceLang"),n&&n.addEventListener("click",(()=>{t?.click()})),t&&t.addEventListener("change",(t=>{this.handleFileSelect(t),r&&(r.style.display="block")})),e&&e.addEventListener("click",(()=>this.handleTranslateClick())),o&&o.addEventListener("click",(()=>this.exportToExcel()))}async exportToExcel(){if(this.currentSheet&&this.data[this.currentSheet])try{const t=function(t){const n=b.utils.book_new();return Object.entries(t).forEach((([t,e])=>{const o=[...e.headerRows,...e.rows],r=b.utils.aoa_to_sheet(o);b.utils.book_append_sheet(n,r,t)})),n}(this.data);b.writeFile(t,`${this.currentFileName.replace(".xlsx","")}_translated.xlsx`),this.log("导出成功","success")}catch(t){t instanceof Error?this.log(`导出失败: ${t.message}`,"error"):this.log("导出失败: 未知错误","error")}else this.log("没有可导出的数据","warning")}getExcelColumnName(t){let n="";for(;t>=0;)n=String.fromCharCode(65+t%26)+n,t=Math.floor(t/26)-1;return n}log(t,n="info"){const e=document.getElementById("logOutput");if(!e)return;const o=document.createElement("div");o.className=`log-entry ${n}`,o.textContent=`[${(new Date).toLocaleTimeString()}] ${t}`,e.appendChild(o),e.scrollTop=e.scrollHeight}updateSheetSelector(t){const n=document.getElementById("sheetSelector");n&&(n.innerHTML="",t.forEach((t=>{const e=document.createElement("option");e.value=t,e.textContent=t,n.appendChild(e)})))}updateCellInDOM(t,n,e){const o=document.getElementById("tableOutput");if(!o)return;const r=o.querySelector(".table-wrapper");if(!r)return;const s=r.querySelector("table");if(!s)return;const{headerRows:a}=this.data[this.currentSheet];if(t<a.length)return;const l=s.querySelectorAll("tr");let i;for(let n=0;n<l.length;n++){const e=l[n],o=e.querySelector(".row-number");if(o&&o.textContent===(t+1).toString()){i=e;break}}if(i&&n+1<i.children.length){const t=i.children[n+1];t&&(t.textContent=e)}}displaySheet(){if(this.tableOutput=document.getElementById("tableOutput"),!this.tableOutput||!this.currentSheet||!this.data[this.currentSheet])return void console.error("无法显示表格：",{tableOutput:!!this.tableOutput,currentSheet:this.currentSheet,hasData:!!this.data[this.currentSheet]});this.tableOutput.innerHTML="";const t=document.createElement("div");t.className="table-wrapper";const n=document.createElement("table");n.className="excel-table";const{headerRows:e,rows:o}=this.data[this.currentSheet],r=[...e,...o],s=Math.max(...e.map((t=>t.length)),...o.map((t=>t.length))),a=document.createElement("tr"),l=document.createElement("th");a.appendChild(l);for(let t=0;t<s;t++){const n=document.createElement("th");n.textContent=this.getExcelColumnName(t),n.className="column-header",a.appendChild(n)}n.appendChild(a),r.forEach(((t,r)=>{const a=document.createElement("tr");if(1!==r&&r<6)return void(a.style.display="none");const l=document.createElement("td");l.textContent=(r+1).toString(),l.className="row-number",a.appendChild(l);for(let n=0;n<s;n++){const s=document.createElement(r<e.length?"th":"td");s.textContent=t[n]||"",r>=e.length&&(s.contentEditable="true"),s.addEventListener("input",(()=>{if(r<e.length)e[r][n]=s.textContent||"";else{const t=r-e.length;for(;o.length<=t;)o.push([]);for(;o[t].length<=n;)o[t].push("");o[t][n]=s.textContent||""}})),a.appendChild(s)}n.appendChild(a)})),t.appendChild(n),this.tableOutput.appendChild(t);const i="fixed-table-style";if(!document.getElementById(i)){const t=document.createElement("style");t.id=i,t.textContent="\n                .table-wrapper {\n                    position: relative;\n                    overflow: auto;\n                    height: 99vh;\n                    max-width: 100%;\n                    border: 1px solid #ccc;\n                    margin: 1px;\n                    scroll-padding-top: 40px; /* 添加滚动填充，防止内容被固定头部遮挡 */\n                }\n                \n                .excel-table {\n                    border-collapse: collapse;\n                }\n                \n                .excel-table th, .excel-table td {\n                    border: 1px solid #ddd;\n                    padding: 8px;\n                    min-width: 100px;\n                }\n                \n                .excel-table th:first-child {\n                    position: sticky;\n                    left: 0;\n                    z-index: 3;\n                    background-color: #f2f2f2;\n                }\n                \n                .excel-table thead th {\n                    position: sticky;\n                    top: 0;\n                    z-index: 2;\n                    background-color: #f2f2f2;\n                    box-shadow: 0 1px 0 rgba(0,0,0,0.1); /* 添加底部阴影，增强视觉效果 */\n                }\n                \n                .excel-table tr:first-child th {\n                    position: sticky;\n                    top: 0;\n                    z-index: 2;\n                    background-color: #f2f2f2;\n                    box-shadow: 0 1px 0 rgba(0,0,0,0.1); /* 添加底部阴影，增强视觉效果 */\n                }\n                \n                /* 处理左上角单元格，同时固定在顶部和左侧 */\n                .excel-table tr:first-child th:first-child {\n                    position: sticky;\n                    top: 0;\n                    left: 0;\n                    z-index: 4; /* 最高层级，确保始终显示在最上层 */\n                    background-color: #f2f2f2;\n                    box-shadow: 1px 1px 0 rgba(0,0,0,0.1); /* 添加右侧和底部阴影 */\n                }\n                \n                .excel-table .row-number {\n                    position: sticky;\n                    left: 0;\n                    z-index: 1;\n                    background-color: #f2f2f2;\n                }\n            ",document.head.appendChild(t)}}}}},e={};function o(t){var r=e[t];if(void 0!==r)return r.exports;var s=e[t]={id:t,exports:{}};return n[t].call(s.exports,s,s.exports,o),s.exports}o.m=n,t=[],o.O=(n,e,r,s)=>{if(!e){var a=1/0;for(h=0;h<t.length;h++){for(var[e,r,s]=t[h],l=!0,i=0;i<e.length;i++)(!1&s||a>=s)&&Object.keys(o.O).every((t=>o.O[t](e[i])))?e.splice(i--,1):(l=!1,s<a&&(a=s));if(l){t.splice(h--,1);var c=r();void 0!==c&&(n=c)}}return n}s=s||0;for(var h=t.length;h>0&&t[h-1][2]>s;h--)t[h]=t[h-1];t[h]=[e,r,s]},o.n=t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return o.d(n,{a:n}),n},o.d=(t,n)=>{for(var e in n)o.o(n,e)&&!o.o(t,e)&&Object.defineProperty(t,e,{enumerable:!0,get:n[e]})},o.o=(t,n)=>Object.prototype.hasOwnProperty.call(t,n),(()=>{var t={792:0};o.O.j=n=>0===t[n];var n=(n,e)=>{var r,s,[a,l,i]=e,c=0;if(a.some((n=>0!==t[n]))){for(r in l)o.o(l,r)&&(o.m[r]=l[r]);if(i)var h=i(o)}for(n&&n(e);c<a.length;c++)s=a[c],o.o(t,s)&&t[s]&&t[s][0](),t[s]=0;return o.O(h)},e=self.webpackChunkexcel_to_structured_data=self.webpackChunkexcel_to_structured_data||[];e.forEach(n.bind(null,0)),e.push=n.bind(null,e.push.bind(e))})(),o.nc=void 0;var r=o.O(void 0,[121],(()=>o(845)));r=o.O(r)})();