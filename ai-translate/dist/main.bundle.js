(()=>{var e,n={3:()=>{},365:(e,n,t)=>{"use strict";t.d(n,{A:()=>i});var o=t(601),r=t.n(o),s=t(314),a=t.n(s)()(r());a.push([e.id,"body {\n    margin: 0;\n    padding: 0;\n    font-family: Arial, sans-serif;\n    background-color: #f5f5f5;\n}\n\n.app-container {\n    display: flex;\n    width: 100%;\n    height: 100vh;\n}\n\n.sidebar {\n    width: 17%;\n    padding: 0px;\n    background-color: #f8f9fa;\n    border-right: 1px solid #dee2e6;\n    overflow-y: auto;\n    display: flex;\n    flex-direction: column;\n}\n\n.main-content {\n    width: 83%;\n    padding: 0px;\n    overflow: hidden;\n    display: flex;\n    flex-direction: column;\n    height: 100%;\n}\n\n.file-input-container {\n    margin: 0px 10px 0px 10px;\n    display: flex;\n    flex-direction: column;\n    gap: 15px;\n    flex-shrink: 0;\n}\n\n.button-group {\n    display: flex;\n    flex-direction: column;\n    gap: 10px;\n    margin: 0px 0px;\n}\n\n.action-buttons-row {\n    display: flex;\n    gap: 10px;\n    width: 100%;\n}\n\n.action-buttons-row .btn {\n    flex: 1;\n}\n\n.source-lang-selector {\n    margin: 10px;\n    display: flex;\n    align-items: center;\n    gap: 10px;\n}\n\n.select-input {\n    flex: 1;\n    padding: 5px;\n    border: 1px solid #ddd;\n    border-radius: 4px;\n}\n\n.log-container {\n    margin-top: 5px;\n    flex: 1;\n    display: flex;\n    flex-direction: column;\n    min-height: 0;\n}\n\n.log-container h3 {\n    margin: 0 0 10px 0;\n    flex-shrink: 0;\n}\n\n.log-output {\n    flex: 1;\n    width: 99%;\n    height: 200px;\n    overflow-y: auto;\n    overflow-x: hidden;\n    background-color: #f8f9fa;\n    border: 1px solid #e9ecef;\n    border-radius: 4px;\n    padding: 0px;\n    font-family: monospace;\n    font-size: 12px;\n}\n\n.excel-table-container {\n    width: 100%;\n    height: 100%;\n    overflow: auto;\n    border: 1px solid #ddd;\n    border-radius: 4px;\n    background-color: white;\n    flex: 1;\n}\n\n.table-output {\n    width: 100%;\n    height: 100%;\n    background-color: white;\n}\n\n.excel-table {\n    width: 100%;\n    border-collapse: collapse;\n    table-layout: fixed; /* 使用固定表格布局，确保单元格宽度限制生效 */\n    min-width: 100%;\n    border-spacing: 0; /* 消除单元格间的间距 */\n}\n\n/* 第一列（行号列）的样式 */\n.excel-table td:first-child,\n.excel-table th:first-child {\n    min-width: 50px;\n    max-width: 80px;\n    text-align: center;\n    background-color: #f8f9fa;\n}\n\n.excel-table th,\n.excel-table td {\n    border: 1px solid #ddd;\n    padding: 8px;\n    text-align: left;\n    min-width: 100px;\n    max-width: 200px; /* 设置最大宽度为200px */\n    width: 200px; /* 固定宽度为200px */\n    white-space: normal;\n    word-wrap: break-word;\n    word-break: break-word; /* 允许在单词内部换行 */\n    overflow: visible; /* 改为可见，确保内容不被裁剪 */\n    height: auto !important; /* 高度自动调整，使用!important确保优先级 */\n    vertical-align: top; /* 内容顶部对齐 */\n    line-height: 1.5; /* 增加行高，使文本更易读 */\n    box-sizing: border-box; /* 确保内边距和边框不会增加元素宽度 */\n}\n\n.excel-table th {\n    background-color: #f8f9fa;\n    font-weight: bold;\n    position: sticky;\n    top: 0;\n    z-index: 10; /* 增加z-index确保表头始终在最上层 */\n    box-shadow: 0 2px 2px -1px rgba(0,0,0,0.1); /* 添加阴影增强视觉效果 */\n}\n\n.excel-table tr:nth-child(even) {\n    background-color: #f8f9fa;\n}\n\n.excel-table tr:hover {\n    background-color: #f5f5f5;\n}\n\n.upload-section {\n    border: 2px dashed #ccc;\n    padding: 20px;\n    text-align: center;\n    border-radius: 8px;\n    transition: all 0.3s ease;\n    display: flex;\n    flex-direction: column;\n    gap: 15px;\n}\n\n.upload-section.drag-over {\n    border-color: #2196F3;\n    background-color: rgba(33, 150, 243, 0.1);\n}\n\n.upload-hint {\n    color: #666;\n    margin: 0;\n    font-size: 14px;\n    transition: all 0.3s ease;\n}\n\n.upload-section.has-file .upload-hint {\n    font-size: 12px;\n    color: #999;\n}\n\n.file-name {\n    margin: 10px 0;\n    font-size: 14px;\n    color: #666;\n}\n\n/* 源语言选择器样式 */\n.source-lang-selector label {\n    color: #333;\n    font-size: 14px;\n    min-width: 70px;\n}\n\n/* 添加样式使单元格内容过多时能正确显示 */\n.excel-table tr {\n    height: auto !important; /* 行高自动调整 */\n}\n\n/* 确保长文本在单元格中正确换行 */\n.excel-table td div,\n.excel-table td span,\n.excel-table td p,\n.excel-table td {\n    max-width: 100%;\n    word-wrap: break-word;\n    word-break: break-word;\n    white-space: pre-wrap; /* 保留空白并允许换行 */\n    text-overflow: ellipsis; /* 文本过长时显示省略号 */\n}\n\n.select-input {\n    flex: 1;\n    padding: 8px 12px;\n    border: 1px solid #2196F3;\n    border-radius: 4px;\n    font-size: 14px;\n    color: #333;\n    background-color: white;\n    cursor: pointer;\n    transition: all 0.3s ease;\n}\n\n.select-input:hover {\n    border-color: #1976D2;\n}\n\n.select-input:focus {\n    outline: none;\n    border-color: #1976D2;\n    box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);\n}\n\n/* 按钮基础样式 */\n.btn {\n    padding: 8px 16px;\n    border: none;\n    border-radius: 4px;\n    cursor: pointer;\n    font-size: 14px;\n    background-color: #2196F3;\n    color: white;\n    transition: background-color 0.3s;\n}\n\n.btn:hover {\n    background-color: #1976D2;\n}\n\n.btn:active {\n    background-color: #1565C0;\n}\n\n.btn:disabled {\n    background-color: #cccccc;\n    cursor: not-allowed;\n}\n\n/* 停止按钮样式 */\n.stop-btn {\n    background-color: #dc3545;\n    color: white;\n}\n\n.stop-btn:hover {\n    background-color: #c82333;\n}\n\n/* 翻译按钮样式 */\n.translate-btn {\n    padding: 8px 16px;\n    border: none;\n    border-radius: 4px;\n    cursor: pointer;\n    font-size: 14px;\n    background-color: #4CAF50;\n    color: white;\n    transition: background-color 0.3s;\n}\n\n.translate-btn:hover {\n    background-color: #45a049;\n}\n\n.translate-btn:disabled {\n    background-color: #cccccc;\n    cursor: not-allowed;\n}\n\n/* 保存按钮样式 */\n#saveBtn, #saveJson {\n    background-color: #4CAF50;\n}\n\n#saveBtn:hover, #saveJson:hover {\n    background-color: #388E3C;\n}\n\n#saveExcel {\n    background-color: #4CAF50;\n}\n\n#saveExcel:hover {\n    background-color: #388E3C;\n}\n\n/* 进度条容器样式 */\n.progress-wrapper {\n    margin: 5px;\n    width: 95%;\n}\n\n.progress-container {\n    width: 100%;\n    height: 20px;\n    background-color: #f0f0f0;\n    border-radius: 4px;\n    overflow: hidden;\n    border: 1px solid #ddd;\n    position: relative;\n}\n\n.progress-fill {\n    height: 100%;\n    width: 0;\n    background-color: #4CAF50;\n    transition: width 0.3s ease;\n}\n\n.progress-text {\n    position: absolute;\n    left: 50%;\n    top: 50%;\n    transform: translate(-50%, -50%);\n    color: #333;\n    font-size: 12px;\n    z-index: 1;\n}\n\n.progress-details {\n    margin-top: 5px;\n    font-size: 12px;\n    color: #666;\n    text-align: center;\n}\n\n.log-container h3 {\n    margin: 0 0 10px 0;\n    color: #333;\n    font-size: 14px;\n}\n\n.log-entry {\n    margin: 5px 0;\n    padding: 5px;\n    border-radius: 3px;\n    word-wrap: break-word;\n}\n\n.log-entry .timestamp {\n    color: #666;\n    margin-right: 8px;\n}\n\n.log-entry.error {\n    color: #dc3545;\n    background-color: rgba(220, 53, 69, 0.1);\n}\n\n.log-entry.warning {\n    color: #ffc107;\n    background-color: rgba(255, 193, 7, 0.1);\n}\n\n.log-entry.success {\n    color: #28a745;\n    background-color: rgba(40, 167, 69, 0.1);\n}\n\n.excel-table th {\n    background-color: #f8f9fa;\n    font-weight: bold;\n}\n\n.excel-table tr:nth-child(even) {\n    background-color: #f8f9fa;\n}\n\n.excel-table tr:hover {\n    background-color: #f5f5f5;\n}\n\n.table-scroll-container {\n    width: 100%;\n    height: 100%;\n    overflow: auto;\n}\n\n.table-scroll-x {\n    width: 100%;\n    overflow-x: auto;\n}\n\n.table-scroll-y {\n    height: 100%;\n    overflow-y: auto;\n}\n\n.container {\n    display: flex;\n    flex-direction: column;\n    min-height: 100vh;\n    padding: 20px;\n    box-sizing: border-box;\n}\n\n.content-wrapper {\n    flex: 1;\n    display: flex;\n    flex-direction: column;\n}\n\n.timestamp {\n    color: #666;\n    font-size: 0.9em;\n    margin-right: 8px;\n}\n\n.error {\n    color: #cc0000;\n    padding: 10px;\n    margin: 10px 0;\n    background-color: #ffe8e8;\n    border: 1px solid #ffcccc;\n    border-radius: 4px;\n}\n\n.progress-container {\n    margin: 10px 0;\n    width: 100%;\n}\n\n.progress-bar {\n    width: 100%;\n    height: 20px;\n    background-color: #f0f0f0;\n    border-radius: 10px;\n    overflow: hidden;\n}\n\n.progress {\n    height: 100%;\n    background-color: #4CAF50;\n    transition: width 0.3s ease-in-out;\n}\n\n.progress-text {\n    margin-top: 5px;\n    text-align: center;\n    color: #666;\n    font-size: 14px;\n}\n",""]);const i=a},729:(e,n,t)=>{"use strict";var o=t(72),r=t.n(o),s=t(825),a=t.n(s),i=t(659),l=t.n(i),c=t(56),d=t.n(c),h=t(540),g=t.n(h),p=t(113),u=t.n(p),x=t(365),f={};f.styleTagTransform=u(),f.setAttributes=d(),f.insert=l().bind(null,"head"),f.domAPI=a(),f.insertStyleElement=g(),r()(x.A,f),x.A&&x.A.locals&&x.A.locals;var m=t(451);class b{constructor(){this.progressContainer=document.querySelector(".progress-container"),this.progressFill=document.querySelector(".progress-fill"),this.progressText=document.querySelector(".progress-text"),this.progressDetails=document.querySelector(".progress-details"),this.progressBatchCounter=document.createElement("div"),this.progressBatchCounter.className="progress-batch-counter",this.progressBatchCounter.style.textAlign="center",this.progressBatchCounter.style.marginTop="5px",this.progressBatchCounter.style.fontSize="14px",this.progressBatchCounter.style.color="#666",this.progressContainer.parentNode?.insertBefore(this.progressBatchCounter,this.progressContainer.nextSibling)}updateProgress(e){const n=e.current/e.total*100;this.progressFill.style.width=`${n}%`,this.progressText.textContent=`${Math.round(n)}%`,e.text&&(this.progressDetails.textContent=e.text)}updateBatchProgress(e){const n=e.completedBatches/e.totalBatches*100;if(this.progressFill.style.width=`${n}%`,this.progressText.textContent=`${Math.round(n)}%`,this.progressBatchCounter.textContent=`批次进度: ${e.completedBatches}/${e.totalBatches}`,e.currentBatchId>0){const n=e.completedTasksInCurrentBatch/e.totalTasksInCurrentBatch*100;this.progressDetails.textContent=`当前批次 ${e.currentBatchId}/${e.totalBatches}: 完成 ${Math.round(n)}%`}}reset(){this.progressFill.style.width="0%",this.progressText.textContent="0%",this.progressDetails.textContent=""}show(){this.progressContainer.style.display="block"}hide(){this.progressContainer.style.display="none"}}class y{constructor(e){this.container=e}log(e,n="info"){if(!this.container)return;const t=document.createElement("div");t.className=`log-entry ${n}`,t.textContent=`[${(new Date).toLocaleTimeString()}] ${e}`,this.container.appendChild(t),this.container.scrollTop=this.container.scrollHeight}}class w{constructor(e){this.container=e}getExcelColumnName(e){let n="";for(;e>=0;)n=String.fromCharCode(65+e%26)+n,e=Math.floor(e/26)-1;return n}updateCellInDOM(e,n,t,o){if(!this.container)return;const r=this.container.querySelector(".table-wrapper");if(!r)return;const s=r.querySelector("table");if(!s)return;if(e<o)return;const a=s.querySelectorAll("tr");let i;for(let n=0;n<a.length;n++){const t=a[n],o=t.querySelector(".row-number");if(o&&o.textContent===(e+1).toString()){i=t;break}}if(i&&n+1<i.children.length){const e=i.children[n+1];e&&(e.textContent=t)}}renderTable(e,n){if(!this.container)return;this.container.innerHTML="";const t=document.createElement("div");t.className="table-wrapper";const o=document.createElement("table");o.className="excel-table";const{headerRows:r,rows:s}=e,a=[...r,...s],i=Math.max(...r.map((e=>e.length)),...s.map((e=>e.length))),l=document.createElement("tr"),c=document.createElement("th");l.appendChild(c);for(let e=0;e<i;e++){const n=document.createElement("th");n.textContent=this.getExcelColumnName(e),n.className="column-header",l.appendChild(n)}o.appendChild(l),a.forEach(((e,t)=>{const s=document.createElement("tr");if(1!==t&&t<6)return void(s.style.display="none");const a=document.createElement("td");a.textContent=(t+1).toString(),a.className="row-number",s.appendChild(a);for(let o=0;o<i;o++){const a=document.createElement(t<r.length?"th":"td");a.textContent=e[o]||"",t>=r.length&&(a.contentEditable="true"),a.addEventListener("input",(()=>{n(t,o,a.textContent||"")})),s.appendChild(a)}o.appendChild(s)})),t.appendChild(o),this.container.appendChild(t),this.addTableStyles()}addTableStyles(){const e="fixed-table-style";if(!document.getElementById(e)){const n=document.createElement("style");n.id=e,n.textContent="\n                .table-wrapper {\n                    position: relative;\n                    overflow: auto;\n                    height: 99vh;\n                    max-width: 100%;\n                    border: 1px solid #ccc;\n                    margin: 1px;\n                    scroll-padding-top: 40px; /* 添加滚动填充，防止内容被固定头部遮挡 */\n                }\n                \n                .excel-table {\n                    border-collapse: collapse;\n                }\n                \n                .excel-table th, .excel-table td {\n                    border: 1px solid #ddd;\n                    padding: 8px;\n                    min-width: 100px;\n                }\n                \n                .excel-table th:first-child {\n                    position: sticky;\n                    left: 0;\n                    z-index: 3;\n                    background-color: #f2f2f2;\n                }\n                \n                .excel-table thead th {\n                    position: sticky;\n                    top: 0;\n                    z-index: 2;\n                    background-color: #f2f2f2;\n                    box-shadow: 0 1px 0 rgba(0,0,0,0.1); /* 添加底部阴影，增强视觉效果 */\n                }\n                \n                .excel-table tr:first-child th {\n                    position: sticky;\n                    top: 0;\n                    z-index: 2;\n                    background-color: #f2f2f2;\n                    box-shadow: 0 1px 0 rgba(0,0,0,0.1); /* 添加底部阴影，增强视觉效果 */\n                }\n                \n                /* 处理左上角单元格，同时固定在顶部和左侧 */\n                .excel-table tr:first-child th:first-child {\n                    position: sticky;\n                    top: 0;\n                    left: 0;\n                    z-index: 4; /* 最高层级，确保始终显示在最上层 */\n                    background-color: #f2f2f2;\n                    box-shadow: 1px 1px 0 rgba(0,0,0,0.1); /* 添加右侧和底部阴影 */\n                }\n                \n                .excel-table .row-number {\n                    position: sticky;\n                    left: 0;\n                    z-index: 1;\n                    background-color: #f2f2f2;\n                }\n            ",document.head.appendChild(n)}}}class k{constructor(e,n){this.apiEndpoint="https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions",this.apiKey=e||"sk-f3488cc61842433194d9ac397e52e548",this.logCallback=n||console.log,this.shouldStopTranslation=!1,this.apiKey&&console.log("已成功加载API密钥")}stopTranslation(){this.shouldStopTranslation=!0}resetStopFlag(){this.shouldStopTranslation=!1}async translateBatch(e,n){try{const t=e.tasks.map((e=>e.rowIndex+3)),o=Math.min(...t),r=Math.max(...t),s=o===r?`第 ${o} 行`:`第 ${o} 行到第 ${r} 行`,a=e.tasks.length>0?e.tasks[0].targetLang:"未知";this.logCallback(`开始翻译批次 ${e.batchId} - ${n} 到 ${a} - ${s} - ${e.tasks.length}个任务`,"info"),(!this.apiKey||"string"==typeof this.apiKey&&""===this.apiKey.trim())&&(this.apiKey="sk-f3488cc61842433194d9ac397e52e548",console.log("从环境变量获取到API密钥"));const i=e.tasks.filter((e=>{try{if("string"!=typeof e.text){if(console.error("警告: 任务文本不是字符串，类型为 "+typeof e.text),null===e.text||void 0===e.text)return!1;e.text=String(e.text)}return""!==e.text.trim()}catch(n){return console.error("过滤任务时出错:",n,e),!1}}));if(0===i.length)return this.logCallback("批次中没有有效的翻译任务","warning"),!1;if(this.shouldStopTranslation)return console.log("翻译被用户停止"),this.logCallback("翻译被用户停止","warning"),!1;try{if(0===i.length)return this.logCallback("没有有效的翻译任务","warning"),!1;console.log(`翻译批次 - 目标语言: ${i[0].targetLang}, 共${i.length}个任务`),i[0].targetLang;const t=await fetch(this.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${"string"==typeof this.apiKey?this.apiKey.trim():this.apiKey}`,Accept:"application/json"},body:JSON.stringify({model:"qwen-mt-turbo",messages:[{role:"user",content:i.map((e=>e.text)).join("\n")}],translation_options:{source_lang:n,target_lang:i[0].targetLang},temperature:.7,max_tokens:2e3})});if(!t.ok){const e=await t.text();throw console.error(`翻译API错误 - 状态码: ${t.status}, 错误信息:`,e),this.logCallback(`翻译API错误: ${t.status} - ${e}`,"error"),new Error(`翻译API错误: ${t.status}`)}const o=await t.text(),r=JSON.parse(o);if(!r.choices?.[0]?.message?.content)throw console.error("翻译返回数据格式错误:",r),this.logCallback("翻译返回数据格式错误","error"),new Error("翻译返回数据格式错误");const s=r.choices[0].message.content,a="string"==typeof s?s.trim().split("\n"):[String(s)];console.log(`收到 ${a.length} 行翻译结果，共 ${i.length} 个任务`);const l=Math.min(a.length,i.length);for(let e=0;e<l;e++){const n=a[e];i[e].text="string"==typeof n?n.trim():String(n),console.log(`翻译成功 - 行号: ${i[e].rowIndex+1}, 译文: ${i[e].text}`)}if(a.length<i.length){const e=i.length-a.length;this.logCallback(`警告: ${e} 个任务没有收到翻译结果`,"warning")}return e.success=!0,!0}catch(n){return console.error(`批量翻译失败 - 批次 ${e.batchId}`,n),console.error("批次任务详情:",e.tasks.map((e=>({rowIndex:e.rowIndex,text:e.text,textType:typeof e.text})))),this.logCallback(`批次 ${e.batchId} 翻译失败: ${n.message||n}`,"error"),e.success=!1,!1}e.completed=e.tasks.length}catch(n){return console.error("批次翻译失败:",n),console.error("错误堆栈:",n.stack||"无堆栈信息"),console.error("批次详细信息:",{batchId:e.batchId,taskCount:e.tasks.length,tasks:e.tasks.map((e=>({rowIndex:e.rowIndex,text:e.text?e.text:null,textType:typeof e.text})))}),this.logCallback(`批次翻译失败: ${n.message||n}`,"error"),e.success=!1,!1}}async processBatches(e,n,t,o){const r=e.length;let s=0;this.logCallback(`开始处理 ${r} 个翻译批次`,"info");for(let a=0;a<e.length;a++){if(this.shouldStopTranslation){this.logCallback("翻译已被用户停止","warning");break}const i=e[a],l=a+1;t({completedBatches:s,totalBatches:r,currentBatchId:l,completedTasksInCurrentBatch:0,totalTasksInCurrentBatch:i.tasks.length});try{const e=await this.translateBatch(i,n);s++,t({completedBatches:s,totalBatches:r,currentBatchId:0,completedTasksInCurrentBatch:i.tasks.length,totalTasksInCurrentBatch:i.tasks.length}),e&&o&&o(i),this.logCallback(`批次 ${l}/${r} 完成`,"success")}catch(e){this.logCallback(`批次 ${l}/${r} 失败`,"error")}}this.logCallback(`翻译任务完成: ${s}/${r} 个批次`,s===r?"success":"warning")}}class C{constructor(e,n,t){this.apiKey=e,this.log=n,this.progressBar=t,this.shouldStopTranslation=!1}stopTranslation(){this.shouldStopTranslation=!0}createBatches(e,n){const t=[];for(let o=0;o<e.length;o+=n)t.push(e.slice(o,o+n));return t}prepareTranslationTasks(e,n,t){const o=[];for(let r=0;r<e.length;r++){const s=e[r];for(;s.length<=Math.max(...t.map((e=>e.index)));)s.push("");const a=s[n];try{if(!a||"string"==typeof a&&""===a.trim()){this.log(`跳过第 ${r+1} 行：源文本为空`,"warning");continue}"string"!=typeof a&&(this.log(`警告: 第 ${r+1} 行的源文本不是字符串，尝试转换`,"warning"),s[n]=String(a))}catch(e){console.error(`处理行 ${r+1} 列 ${n} 的源文本时出错:`,e),this.log(`警告: 处理行 ${r+1} 列 ${n} 时出错，跳过该行`,"warning");continue}for(const e of t){try{const n=s[e.index];if(null!=n&&"string"==typeof n&&""!==n.trim())continue}catch(n){console.error(`处理行 ${r+1} 列 ${e.index} 时出错:`,n),this.log(`警告: 处理行 ${r+1} 列 ${e.index} 时出错`,"warning")}o.push({text:a,targetLang:e.langCode,rowIndex:r,columnIndex:n,targetColumnIndex:e.index,langDisplay:e.display})}}return o}organizeTasksIntoBatches(e){const n=[];let t=1;const o={};for(const n of e)o[n.targetLang]||(o[n.targetLang]=[]),o[n.targetLang].push(n);this.log(`已将翻译任务分组为 ${Object.keys(o).length} 种目标语言`,"info");for(const e in o){const r=o[e],s=r[0].langDisplay;this.log(`处理目标语言 ${s} 的 ${r.length} 个任务`,"info");let a=[],i=0;const l=2e3,c=20;for(let e=0;e<r.length;e++){const o=r[e];if((a.length>=c||i+("string"==typeof o.text?o.text.length:0)>l)&&a.length>0){const e={tasks:[...a],batchId:t++,totalCharCount:i};n.push(e),a=[],i=0}if(o.text.length>l){this.log(`警告: 任务字符数(${o.text.length})超过限制(${l})，单独处理`,"warning");const e={tasks:[o],batchId:t++,totalCharCount:o.text.length};n.push(e)}else a.push(o),i+=o.text.length}if(a.length>0){const e={tasks:a,batchId:t++,totalCharCount:i};n.push(e)}}return this.log(`将翻译任务分成了 ${n.length} 个批次`,"info"),n}async executeTranslation(e,n,t,o,r){try{this.log("正在收集需要翻译的内容...","info");const s=this.prepareTranslationTasks(e,n,o);if(0===s.length)return void this.log("没有找到需要翻译的内容","warning");this.log(`找到 ${s.length} 个需要翻译的单元格`,"info");const a=this.organizeTasksIntoBatches(s),i=new k(this.apiKey,this.log),l=t;await i.processBatches(a,l,(e=>{this.progressBar.updateBatchProgress(e)}),(n=>{let t=0;for(const o of n.tasks)o.text&&"string"==typeof o.text&&""!==o.text.trim()?(e[o.rowIndex][o.targetColumnIndex]=o.text,r(o.rowIndex+2,o.targetColumnIndex,o.text)):t++;t>0&&this.log(`警告: ${t} 个任务没有收到翻译结果`,"warning");const o=n.tasks.length>0?n.tasks[0].langDisplay:"";this.log(`已更新 ${o} 的翻译结果`,"info")})),this.log("所有翻译任务完成","success")}catch(e){const n=e.message||String(e),t=e.stack||"No stack trace available";console.error("翻译过程出错:",e),console.error("错误堆栈:",t);try{const e=t.split("\n").slice(0,3).join("\n");this.log(`翻译过程出错: ${n}\n${e}`,"error")}catch(e){this.log(`翻译过程出错: ${n}`,"error"),console.error("解析错误堆栈时出错:",e)}}}}class v{static getLanguageMappings(){return{zh:{name:"简体中文",apiCode:"zh-CN",columnHeaders:["简体中文","中文"]},en:{name:"英语",apiCode:"en-US",columnHeaders:["英语","英文","English"]},ja:{name:"日语",apiCode:"ja-JP",columnHeaders:["日语","日文","Japanese"]},ko:{name:"韩语",apiCode:"ko-KR",columnHeaders:["韩语","韩文","Korean"]},es:{name:"西班牙语",apiCode:"es-ES",columnHeaders:["西班牙语","Spanish"]},fr:{name:"法语",apiCode:"fr-FR",columnHeaders:["法语","法文","French"]},de:{name:"德语",apiCode:"de-DE",columnHeaders:["德语","德文","German"]},ru:{name:"俄语",apiCode:"ru-RU",columnHeaders:["俄语","俄文","Russian"]},th:{name:"泰语",apiCode:"th-TH",columnHeaders:["泰语","泰文","Thai"]},it:{name:"意大利语",apiCode:"it-IT",columnHeaders:["意大利语","Italian"]},id:{name:"印尼语",apiCode:"id-ID",columnHeaders:["印尼语","印度尼西亚语","Indonesian"]},pt:{name:"葡萄牙语",apiCode:"pt-PT",columnHeaders:["葡萄牙语","Portuguese"]}}}static getLanguageOptions(){const e=this.getLanguageMappings();return Object.entries(e).map((([e,n])=>({code:e,name:n.name,apiCode:n.apiCode})))}static getLanguageDisplayName(e){const n=this.getLanguageMappings();return n[e]?.name||e}static getApiLanguageCode(e){const n=this.getLanguageMappings();return n[e]?.apiCode||e}static guessLanguageFromColumnHeader(e){if(!e)return null;const n=this.getLanguageMappings(),t=e.trim().toLowerCase();for(const[e,o]of Object.entries(n))if(o.columnHeaders.some((e=>t===e.toLowerCase())))return{langCode:e,apiCode:o.apiCode,name:o.name};return null}}class S{constructor(){this.tableOutput=document.getElementById("tableOutput"),this.logOutput=document.getElementById("logOutput"),this.logger=new y(this.logOutput),this.progressBar=new b,this.tableRenderer=new w(this.tableOutput),this.data={},this.currentSheet=null,this.currentFileName="",this.apiKey="",this.shouldStopTranslation=!1,this.sourceLangSelect=null,this.apiKey="sk-f3488cc61842433194d9ac397e52e548",console.log("已从环境变量加载API密钥"),this.initializeUI(),this.initializeEventListeners()}initializeUI(){this.progressBar.show(),this.progressBar.updateProgress({current:0,total:100}),this.progressBar.hide();const e=document.getElementById("stopTranslateBtn");e&&e.addEventListener("click",(()=>{this.shouldStopTranslation=!0,e.disabled=!0,this.logger.log("正在停止翻译...","warning")}))}initializeEventListeners(){const e=document.getElementById("fileInput"),n=document.getElementById("uploadBtn"),t=document.getElementById("translateBtn"),o=document.getElementById("exportBtn"),r=document.getElementById("actionButtons");this.sourceLangSelect=document.getElementById("sourceLang"),n&&n.addEventListener("click",(()=>{e?.click()})),e&&e.addEventListener("change",(e=>{this.handleFileSelect(e),r&&(r.style.display="block")})),t&&t.addEventListener("click",(()=>this.handleTranslateClick())),o&&o.addEventListener("click",(()=>this.exportToExcel()))}async handleFileSelect(e){const n=e.target.files[0];if(n)try{this.currentFileName=n.name,this.logger.log(`正在读取文件: ${n.name}`,"info"),this.progressBar.show(),this.data=await function(e){return new Promise(((n,t)=>{const o=new FileReader;o.onload=e=>{try{const t=e.target?.result,o=m.read(t,{type:"binary"}),r={};o.SheetNames.forEach((e=>{const n=o.Sheets[e],t=m.utils.sheet_to_json(n,{header:1}),s=t.slice(0,2),a=t.slice(2);r[e]={headerRows:s,rows:a}})),n(r)}catch(e){t(e)}},o.onerror=()=>{t(new Error("文件读取失败"))},o.readAsBinaryString(e)}))}(n),this.updateSheetSelector(Object.keys(this.data)),Object.keys(this.data).length>0&&(this.currentSheet=Object.keys(this.data)[0],this.displaySheet(),this.logger.log(`已加载工作表: ${this.currentSheet}`,"success")),this.autoDetectSourceLanguage()}catch(e){this.logger.log(`读取文件失败: ${e.message}`,"error"),console.error("文件读取错误:",e)}finally{this.progressBar.hide()}}autoDetectSourceLanguage(){if(!this.currentSheet||!this.data[this.currentSheet]||!this.sourceLangSelect)return;const{headerRows:e}=this.data[this.currentSheet];if(e.length<2)return;const n=e[1];for(let e=0;e<n.length;e++){const t=n[e],o=v.guessLanguageFromColumnHeader(t);if(o&&"zh"===o.langCode){this.sourceLangSelect.value=o.langCode,this.logger.log(`已自动检测到源语言列: ${t} (列 ${this.getExcelColumnName(e)})`,"info");break}}}updateSheetSelector(e){const n=document.getElementById("sheetSelector");n&&(n.innerHTML="",e.forEach((e=>{const t=document.createElement("option");t.value=e,t.textContent=e,n.appendChild(t)})),n.addEventListener("change",(()=>{this.currentSheet=n.value,this.displaySheet(),this.logger.log(`已切换到工作表: ${this.currentSheet}`,"info")})))}displaySheet(){if(!this.tableOutput||!this.currentSheet||!this.data[this.currentSheet])return void console.error("无法显示表格：",{tableOutput:!!this.tableOutput,currentSheet:this.currentSheet,hasData:!!this.data[this.currentSheet]});const e=this.data[this.currentSheet];this.tableRenderer.renderTable(e,((n,t,o)=>{if(n<e.headerRows.length)e.headerRows[n][t]=o;else{const r=n-e.headerRows.length;for(;e.rows.length<=r;)e.rows.push([]);for(;e.rows[r].length<=t;)e.rows[r].push("");e.rows[r][t]=o}}))}async handleTranslateClick(){if(!this.currentSheet||!this.data[this.currentSheet])return void this.logger.log("没有可翻译的数据","warning");const e=document.getElementById("translateBtn"),n=document.getElementById("stopTranslateBtn");if(e&&(e.style.display="none"),n&&(n.style.display="inline-block",n.disabled=!1),this.shouldStopTranslation=!1,this.progressBar.show(),this.progressBar.updateProgress({current:0,total:100}),this.apiKey="sk-f3488cc61842433194d9ac397e52e548",console.log("使用环境变量中的API密钥"),!this.apiKey)return this.logger.log("请输入API密钥","error"),e.style.display="inline-block",n.style.display="none",void this.progressBar.hide();const t=this.sourceLangSelect?.value||"zh",{headerRows:o,rows:r}=(v.getApiLanguageCode(t),this.data[this.currentSheet]);if(o.length<2)return this.logger.log("错误：表格缺少表头行","error"),e.style.display="inline-block",n.style.display="none",void this.progressBar.hide();const s=o[1];let a=-1;for(let e=0;e<s.length;e++){const n=s[e],o=v.guessLanguageFromColumnHeader(n);if(o&&o.langCode===t){a=e;break}}if(-1===a)return this.logger.log(`错误：找不到源语言(${v.getLanguageDisplayName(t)})列`,"error"),e.style.display="inline-block",n.style.display="none",void this.progressBar.hide();const i=[];for(let e=0;e<s.length;e++){if(e===a)continue;const n=s[e],o=v.guessLanguageFromColumnHeader(n);o&&o.langCode!==t&&i.push({index:e,langCode:o.langCode,display:o.name})}if(0===i.length)return this.logger.log("错误：找不到任何目标语言列","error"),e.style.display="inline-block",n.style.display="none",void this.progressBar.hide();this.logger.log(`开始翻译，源语言: ${v.getLanguageDisplayName(t)} (列 ${this.getExcelColumnName(a)})`,"info"),this.logger.log("目标语言: "+i.map((e=>`${e.display} (列 ${this.getExcelColumnName(e.index)})`)).join(", "),"info");try{const e=new C(this.apiKey,this.logger.log.bind(this.logger),this.progressBar);n&&(n.onclick=()=>{this.shouldStopTranslation=!0,e.stopTranslation(),n.disabled=!0,this.logger.log("正在停止翻译...","warning")}),await e.executeTranslation(r,a,t,i,((e,n,t)=>{this.tableRenderer.updateCellInDOM(e,n,t,o.length)}))}catch(e){console.error("翻译过程出错:",e),this.logger.log(`翻译过程出错: ${e.message||String(e)}`,"error")}finally{e.style.display="inline-block",n.style.display="none",n.disabled=!0,this.progressBar.hide()}}async exportToExcel(){if(this.currentSheet&&this.data[this.currentSheet])try{const e=function(e){const n=m.utils.book_new();return Object.entries(e).forEach((([e,t])=>{const o=[...t.headerRows,...t.rows],r=m.utils.aoa_to_sheet(o);m.utils.book_append_sheet(n,r,e)})),n}(this.data);m.writeFile(e,`${this.currentFileName.replace(".xlsx","")}_translated.xlsx`),this.logger.log("导出成功","success")}catch(e){e instanceof Error?this.logger.log(`导出失败: ${e.message}`,"error"):this.logger.log("导出失败: 未知错误","error")}else this.logger.log("没有可导出的数据","warning")}getExcelColumnName(e){return this.tableRenderer.getExcelColumnName(e)}}window.addEventListener("DOMContentLoaded",(()=>{window.excelTranslatorInstance=new S}))}},t={};function o(e){var r=t[e];if(void 0!==r)return r.exports;var s=t[e]={id:e,exports:{}};return n[e].call(s.exports,s,s.exports,o),s.exports}o.m=n,e=[],o.O=(n,t,r,s)=>{if(!t){var a=1/0;for(d=0;d<e.length;d++){for(var[t,r,s]=e[d],i=!0,l=0;l<t.length;l++)(!1&s||a>=s)&&Object.keys(o.O).every((e=>o.O[e](t[l])))?t.splice(l--,1):(i=!1,s<a&&(a=s));if(i){e.splice(d--,1);var c=r();void 0!==c&&(n=c)}}return n}s=s||0;for(var d=e.length;d>0&&e[d-1][2]>s;d--)e[d]=e[d-1];e[d]=[t,r,s]},o.n=e=>{var n=e&&e.__esModule?()=>e.default:()=>e;return o.d(n,{a:n}),n},o.d=(e,n)=>{for(var t in n)o.o(n,t)&&!o.o(e,t)&&Object.defineProperty(e,t,{enumerable:!0,get:n[t]})},o.o=(e,n)=>Object.prototype.hasOwnProperty.call(e,n),(()=>{var e={792:0};o.O.j=n=>0===e[n];var n=(n,t)=>{var r,s,[a,i,l]=t,c=0;if(a.some((n=>0!==e[n]))){for(r in i)o.o(i,r)&&(o.m[r]=i[r]);if(l)var d=l(o)}for(n&&n(t);c<a.length;c++)s=a[c],o.o(e,s)&&e[s]&&e[s][0](),e[s]=0;return o.O(d)},t=self.webpackChunkexcel_to_structured_data=self.webpackChunkexcel_to_structured_data||[];t.forEach(n.bind(null,0)),t.push=n.bind(null,t.push.bind(t))})(),o.nc=void 0;var r=o.O(void 0,[121],(()=>o(729)));r=o.O(r)})();